---
phase: 04-short-form-resolution
plan: 04
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - src/extract/extractCitations.ts
  - src/index.ts
  - tests/integration/resolution.test.ts
  - README.md
autonomous: true

must_haves:
  truths:
    - "Developer can extract and resolve citations in one call via resolve option"
    - "Short-form citations (Id., supra) are extracted alongside full citations"
    - "extractCitations with resolve: true returns ResolvedCitation array"
    - "Integration tests validate end-to-end extraction → resolution flow"
    - "README documents resolution API with examples"
  artifacts:
    - path: "src/extract/extractCitations.ts"
      provides: "Updated pipeline with resolve option and short-form extraction"
      contains: "resolve?: boolean"
    - path: "tests/integration/resolution.test.ts"
      provides: "End-to-end resolution integration tests"
      min_lines: 100
    - path: "README.md"
      provides: "Resolution API documentation and examples"
      contains: "resolveCitations"
  key_links:
    - from: "src/extract/extractCitations.ts"
      to: "src/resolve/index.ts"
      via: "Calls resolveCitations if resolve option enabled"
      pattern: "resolveCitations\\(citations"
    - from: "src/extract/extractCitations.ts"
      to: "src/extract/extractShortForms.ts"
      via: "Uses extractId/extractSupra/extractShortFormCase for tokens"
      pattern: "extractId|extractSupra|extractShortFormCase"
    - from: "src/index.ts"
      to: "src/resolve/index.ts"
      via: "Re-exports resolution API"
      pattern: "export.*from.*resolve"
---

<objective>
Integrate resolution into extraction pipeline with resolve option, wire short-form extraction into main pipeline, add end-to-end integration tests, and document resolution API in README.

Purpose: Complete the extraction → resolution workflow. Developers can extract and resolve citations in one call. Short-form citations are detected and extracted like full citations. Integration tests validate complete Phase 4 functionality. Documentation guides developers through resolution API.

Output: extractCitations with resolve option, short-form citations integrated into extraction pipeline, integration tests, README documentation with examples.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-RESEARCH.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-CONTEXT.md
@/Users/medelman/GitHub/medelman17/eyecitets/src/extract/extractCitations.ts
@/Users/medelman/GitHub/medelman17/eyecitets/src/index.ts
@/Users/medelman/GitHub/medelman17/eyecitets/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate short-form extraction and resolution into main pipeline</name>
  <files>
    src/extract/extractCitations.ts
    src/extract/index.ts
    src/index.ts
  </files>
  <action>
**Part A: Update extraction pipeline (src/extract/extractCitations.ts)**

Add resolve option and integrate short-form extractors from Plan 02:

1. **Add resolve option to function signatures:**
   ```typescript
   export function extractCitations(
     text: string,
     options?: {
       cleaners?: Array<(text: string) => { cleaned: string; map: TransformationMap }>
       resolve?: boolean  // NEW
       resolveOptions?: Partial<ResolutionOptions>  // NEW
     }
   ): Citation[] | ResolvedCitation[]
   ```

2. **Import short-form extractors from Plan 02:**
   ```typescript
   import { extractId, extractSupra, extractShortFormCase } from './extractShortForms'
   import type { ResolutionOptions, ResolvedCitation } from '../resolve/types'
   ```

3. **Include SHORT_FORM_PATTERNS in tokenization:**
   - SHORT_FORM_PATTERNS already added to tokenizer in Plan 02 Task 1
   - Tokenizer will now find Id., Ibid., supra, short-form alongside full citations
   - No changes needed here - patterns already integrated

4. **Add short-form extraction to extraction logic:**
   After existing extraction logic (extractCase, extractStatute, etc.), add:
   ```typescript
   // Extract short-form citations (Plan 02 extractors)
   const idResult = extractId(token.text, span)
   if (idResult) {
     citations.push(idResult)
     continue
   }

   const supraResult = extractSupra(token.text, span)
   if (supraResult) {
     citations.push(supraResult)
     continue
   }

   const shortFormResult = extractShortFormCase(token.text, span)
   if (shortFormResult) {
     citations.push(shortFormResult)
     continue
   }
   ```

5. **Call resolveCitations if resolve option enabled:**
   At the end of extractCitations function, before return:
   ```typescript
   if (options?.resolve) {
     const { resolveCitations } = await import('../resolve')
     return resolveCitations(citations, text, options.resolveOptions)
   }
   return citations
   ```

6. **Update return type based on resolve option:**
   Use TypeScript function overloading for correct inference:
   ```typescript
   export function extractCitations(
     text: string,
     options: { resolve: true; cleaners?: Array<...>; resolveOptions?: Partial<ResolutionOptions> }
   ): ResolvedCitation[]

   export function extractCitations(
     text: string,
     options?: { resolve?: false; cleaners?: Array<...> }
   ): Citation[]

   export function extractCitations(
     text: string,
     options?: { resolve?: boolean; cleaners?: Array<...>; resolveOptions?: Partial<ResolutionOptions> }
   ): Citation[] | ResolvedCitation[] {
     // Implementation
   }
   ```

**Part B: Update exports (src/extract/index.ts, src/index.ts)**

src/extract/index.ts already exports extractId/extractSupra/extractShortFormCase from Plan 02.

Update src/index.ts to add resolution exports:
```typescript
// Resolution API (Plan 03 output)
export { resolveCitations, DocumentResolver } from './resolve'
export type { ResolutionResult, ResolutionOptions, ResolvedCitation } from './resolve'
```

Follow existing export patterns from Phase 2 (convenience + granular + types).
  </action>
  <verify>
    npm run typecheck
    grep "resolve?: boolean" src/extract/extractCitations.ts
    grep "resolveCitations" src/index.ts
  </verify>
  <done>
extractCitations includes resolve option, short-form extractors wired into extraction loop, resolution exports added to src/index.ts, TypeScript compilation succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests and update documentation</name>
  <files>
    tests/integration/resolution.test.ts
    README.md
  </files>
  <action>
**Part A: Create integration tests (tests/integration/resolution.test.ts)**

Validate end-to-end extraction → resolution workflow using WORKING resolution from Plan 03:

1. **Basic Id. resolution integration:**
   - Text: "See Smith v. Jones, 500 F.2d 123 (2020). Id. at 125."
   - Extract citations (should find 2: case + id)
   - Resolve citations
   - Verify Id. resolves to Smith v. Jones case
   - Verify resolution.confidence === 1.0

2. **Paragraph scope boundary:**
   - Text with two paragraphs (double newline separator)
   - First paragraph: "Smith v. Jones, 500 F.2d 123."
   - Second paragraph: "Id. at 125."
   - Resolve with paragraph scope (default)
   - Verify Id. fails to resolve (antecedent outside scope)
   - Verify resolution.failureReason contains "paragraph"

3. **Supra resolution with fuzzy matching:**
   - Text: "Smith, Inc. v. State, 600 F.3d 456 (2021). Later, Smith, supra, at 460."
   - Extract and resolve
   - Verify supra resolves to "Smith, Inc." case using fuzzy matching
   - Verify confidence >= 0.7 (fuzzy match confidence)

4. **Short-form case resolution:**
   - Text: "Brown v. Board, 347 U.S. 483 (1954). See also 347 U.S. at 495."
   - Extract and resolve
   - Verify short-form "347 U.S. at 495" resolves to Brown case
   - Verify volume and reporter match

5. **Convenience API (resolve option):**
   - Text with Id. and full case
   - Call extractCitations(text, { resolve: true })
   - Verify result is ResolvedCitation[] with resolution fields
   - Verify Id. citation has resolution.resolvedTo populated

6. **Unresolved citation warnings:**
   - Text: "Id. at 123." (no preceding citation)
   - Extract and resolve
   - Verify resolution.failureReason exists
   - Verify warnings array contains helpful message

7. **Parallel processing safety:**
   - Two different documents processed with Promise.all
   - Verify no state leakage between documents
   - Each Id. resolves to its own document's antecedent, not the other document's

Use realistic legal text examples. Follow integration test patterns from tests/integration/fullPipeline.test.ts (Phase 2).

Test structure:
```typescript
import { describe, it, expect } from 'vitest'
import { extractCitations, resolveCitations } from '@/index'

describe('Resolution Integration', () => {
  it('resolves Id. to preceding full citation', () => {
    const text = 'Smith v. Jones, 500 F.2d 123 (2020). Id. at 125.'
    const citations = extractCitations(text, { resolve: true })

    expect(citations).toHaveLength(2)

    const idCitation = citations.find(c => c.type === 'id')
    expect(idCitation).toBeDefined()
    expect(idCitation?.resolution?.resolvedTo).toBeDefined()
    expect(idCitation?.resolution?.resolvedTo?.type).toBe('case')
    expect(idCitation?.resolution?.confidence).toBe(1.0)
  })

  it('enforces paragraph scope boundaries', () => {
    const text = 'Smith v. Jones, 500 F.2d 123.\n\nId. at 125.'
    const citations = extractCitations(text)
    const resolved = resolveCitations(citations, text, { scopeStrategy: 'paragraph' })

    const idCitation = resolved.find(c => c.type === 'id')
    expect(idCitation?.resolution?.resolvedTo).toBeUndefined()
    expect(idCitation?.resolution?.failureReason).toContain('paragraph')
  })

  it('resolves supra with fuzzy party name matching', () => {
    const text = 'Smith, Inc. v. State, 600 F.3d 456 (2021). Later, Smith, supra, at 460.'
    const citations = extractCitations(text, { resolve: true })

    const supraCitation = citations.find(c => c.type === 'supra')
    expect(supraCitation?.resolution?.resolvedTo).toBeDefined()
    expect(supraCitation?.resolution?.confidence).toBeGreaterThanOrEqual(0.7)
  })

  it('resolves short-form case by volume and reporter', () => {
    const text = 'Brown v. Board, 347 U.S. 483 (1954). See also 347 U.S. at 495.'
    const citations = extractCitations(text, { resolve: true })

    const shortFormCitation = citations.find(c => c.type === 'shortFormCase')
    expect(shortFormCitation?.resolution?.resolvedTo).toBeDefined()
    expect(shortFormCitation?.resolution?.resolvedTo?.type).toBe('case')
  })

  it('reports unresolved citations with warnings', () => {
    const text = 'Id. at 123.'
    const citations = extractCitations(text, { resolve: true })

    const idCitation = citations[0]
    expect(idCitation.resolution?.resolvedTo).toBeUndefined()
    expect(idCitation.resolution?.failureReason).toBeDefined()
    expect(idCitation.resolution?.warnings).toHaveLength(1)
  })

  it('prevents state leakage across documents', async () => {
    const doc1 = 'Smith v. Jones, 500 F.2d 123. Id.'
    const doc2 = 'Brown v. Board, 347 U.S. 483. Id.'

    const results = await Promise.all([
      extractCitations(doc1, { resolve: true }),
      extractCitations(doc2, { resolve: true })
    ])

    const doc1Id = results[0].find(c => c.type === 'id')
    const doc2Id = results[1].find(c => c.type === 'id')

    expect(doc1Id?.resolution?.resolvedTo?.text).toContain('Smith')
    expect(doc2Id?.resolution?.resolvedTo?.text).toContain('Brown')
  })
})
```

**Part B: Update README documentation (README.md)**

Add comprehensive resolution documentation after existing extraction examples:

1. **Resolution section header:** "## Resolving Short-Form Citations"

2. **Explain what resolution does:**
   - Links Id., supra, short-form citations to their full antecedents
   - Respects paragraph scope boundaries by default
   - Returns warnings for unresolved citations

3. **Convenience API example:**
   ```typescript
   import { extractCitations } from 'eyecite-ts'

   const text = `Smith v. Jones, 500 F.2d 123 (2020). Id. at 125.`
   const citations = extractCitations(text, { resolve: true })

   for (const cite of citations) {
     if (cite.resolution?.resolvedTo) {
       console.log(`${cite.text} → ${cite.resolution.resolvedTo.text}`)
     }
   }
   ```

4. **Power-user API example:**
   ```typescript
   import { extractCitations, resolveCitations } from 'eyecite-ts'

   const citations = extractCitations(text)
   const resolved = resolveCitations(citations, text, {
     scopeStrategy: 'none',  // Allow Id. across entire document
     partyMatchThreshold: 0.7,  // Lower supra matching threshold
   })
   ```

5. **Resolution options table:**

   | Option | Type | Default | Description |
   |--------|------|---------|-------------|
   | `scopeStrategy` | `'paragraph' \| 'section' \| 'footnote' \| 'none'` | `'paragraph'` | Scope boundary for Id. resolution |
   | `partyMatchThreshold` | `number` (0-1) | `0.8` | Fuzzy matching threshold for supra |
   | `fuzzyPartyMatching` | `boolean` | `true` | Enable Levenshtein distance matching |
   | `reportUnresolved` | `boolean` | `true` | Include warnings for unresolved citations |

6. **Handling unresolved citations example:**
   ```typescript
   const resolved = resolveCitations(citations, text)
   const unresolved = resolved.filter(c => !c.resolution?.resolvedTo)

   for (const cite of unresolved) {
     console.warn(`Unresolved: ${cite.text}`)
     console.warn(`Reason: ${cite.resolution?.failureReason}`)
   }
   ```

Insert resolution section after "Citation Extraction" section, before "Development" section. Keep examples concise and practical. Use TypeScript syntax highlighting.
  </action>
  <verify>
    npm test -- integration/resolution --run
    grep "resolveCitations" README.md
  </verify>
  <done>
Integration tests pass validating Id./supra/short-form resolution, paragraph scope boundaries, convenience API, unresolved warnings, and parallel processing safety. README includes resolution section with examples, options table, and unresolved citation handling. All tests pass (139 existing + new resolution tests).
  </done>
</task>

</tasks>

<verification>
- [ ] extractCitations supports resolve option returning ResolvedCitation[]
- [ ] Short-form extractors (extractId/extractSupra/extractShortFormCase) wired into extraction pipeline
- [ ] Resolution API exported from src/index.ts
- [ ] Integration tests validate end-to-end extraction → resolution
- [ ] README documents resolution with examples and options
- [ ] All tests pass including new integration tests
- [ ] TypeScript strict mode compilation succeeds
</verification>

<success_criteria>
Developer can extract and resolve citations in one call using resolve option. Short-form citations (Id., supra) are extracted alongside full citations. Integration tests prove end-to-end workflow correctness with WORKING resolution (not stubbed). README guides developers through resolution API with practical examples. Phase 4 complete, v1.0 ready.
</success_criteria>

<output>
After completion, create `.planning/phases/04-short-form-resolution/04-04-SUMMARY.md`
</output>
