---
phase: 04-short-form-resolution
plan: 04
type: execute
wave: 3
depends_on: [04-01, 04-02, 04-03]
files_modified:
  - src/extract/extractCitations.ts
  - src/extract/extractShortForms.ts
  - src/index.ts
  - tests/integration/resolution.test.ts
  - README.md
autonomous: true

must_haves:
  truths:
    - "Developer can extract and resolve citations in one call via resolve option"
    - "Short-form citations (Id., supra) are extracted alongside full citations"
    - "extractCitations with resolve: true returns ResolvedCitation array"
    - "Integration tests validate end-to-end extraction → resolution flow"
    - "README documents resolution API with examples"
  artifacts:
    - path: "src/extract/extractShortForms.ts"
      provides: "Extraction functions for Id., supra citations using SHORT_FORM_PATTERNS"
      exports: ["extractId", "extractSupra"]
    - path: "src/extract/extractCitations.ts"
      provides: "Updated pipeline with resolve option and short-form extraction"
      contains: "resolve?: boolean"
    - path: "tests/integration/resolution.test.ts"
      provides: "End-to-end resolution integration tests"
      min_lines: 100
    - path: "README.md"
      provides: "Resolution API documentation and examples"
      contains: "resolveCitations"
  key_links:
    - from: "src/extract/extractCitations.ts"
      to: "src/resolve/index.ts"
      via: "Calls resolveCitations if resolve option enabled"
      pattern: "resolveCitations\\(citations"
    - from: "src/extract/extractShortForms.ts"
      to: "src/patterns/shortForm.ts"
      via: "Uses SHORT_FORM_PATTERNS for tokenization"
      pattern: "SHORT_FORM_PATTERNS"
    - from: "src/index.ts"
      to: "src/resolve/index.ts"
      via: "Re-exports resolution API"
      pattern: "export.*from.*resolve"
---

<objective>
Integrate resolution into extraction pipeline with resolve option, implement short-form extraction (Id., supra), add end-to-end integration tests, and document resolution API in README.

Purpose: Complete the extraction → resolution workflow. Developers can extract and resolve citations in one call. Short-form citations are detected and extracted like full citations. Integration tests validate complete Phase 4 functionality. Documentation guides developers through resolution API.

Output: extractCitations with resolve option, extractId/extractSupra functions, integration tests, README documentation with examples.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-RESEARCH.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-CONTEXT.md
@/Users/medelman/GitHub/medelman17/eyecitets/src/extract/extractCitations.ts
@/Users/medelman/GitHub/medelman17/eyecitets/src/index.ts
@/Users/medelman/GitHub/medelman17/eyecitets/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement short-form extraction and integrate with pipeline</name>
  <files>
    src/extract/extractShortForms.ts
    src/extract/extractCitations.ts
    src/extract/index.ts
    src/index.ts
  </files>
  <action>
**Part A: Create short-form extractors (src/extract/extractShortForms.ts)**

Follow Phase 2 extraction patterns (see extractCase.ts, extractStatute.ts) to create extractors for Id. and supra:

1. **extractId(token: Token, text: string, map: TransformationMap): IdCitation**
   - Parse matched text for pincite using idPattern from SHORT_FORM_PATTERNS
   - Extract pincite number from "Id. at 125" pattern (capture group 1)
   - Return IdCitation with type: "id", pincite if present
   - Use token positions for span (cleanStart/End → originalStart/End via map)
   - Confidence: 1.0 (Id. is unambiguous)
   - Follow existing extractor patterns for consistency

2. **extractSupra(token: Token, text: string, map: TransformationMap): SupraCitation**
   - Parse matched text for party name and pincite using supraPattern
   - Extract party name from capture group 1 ("Smith" from "Smith, supra")
   - Extract pincite from capture group 2 if present
   - Return SupraCitation with type: "supra", partyName, pincite
   - Confidence: 0.9 (supra pattern is strong but party name may be ambiguous)

3. **Export both functions** with JSDoc following Phase 2 extractor documentation style

Handle both Id. and Ibid. patterns (treat Ibid. as Id. variant per CONTEXT.md).

**Part B: Update extraction pipeline (src/extract/extractCitations.ts)**

Add resolve option to extractCitations and extractCitationsAsync:

1. **Add resolve option to function signatures:**
   ```typescript
   export function extractCitations(
     text: string,
     options?: {
       cleaners?: Array<(text: string) => { cleaned: string; map: TransformationMap }>
       resolve?: boolean  // NEW
       resolveOptions?: Partial<ResolutionOptions>  // NEW
     }
   ): Citation[] | ResolvedCitation[]
   ```

2. **Include short-form patterns in tokenization:**
   - Add SHORT_FORM_PATTERNS to pattern concatenation alongside case, statute, journal patterns
   - Tokenizer will now find Id., Ibid., supra alongside full citations

3. **Add short-form extraction to extraction logic:**
   - After extracting case/statute/journal/etc, check token type for id/supra
   - Call extractId() or extractSupra() based on pattern match
   - Add extracted short-form citations to results

4. **Call resolveCitations if resolve option enabled:**
   ```typescript
   if (options?.resolve) {
     const { resolveCitations } = await import('../resolve')
     return resolveCitations(citations, options.resolveOptions)
   }
   return citations
   ```

5. **Update return type based on resolve option:**
   - If resolve: true, return type is ResolvedCitation[]
   - If resolve: false or undefined, return type is Citation[]
   - Use TypeScript conditional types for correct inference

**Part C: Update exports (src/extract/index.ts, src/index.ts)**

Add short-form extractors to granular exports in src/extract/index.ts:
```typescript
export { extractId, extractSupra } from './extractShortForms'
```

Add resolution exports to main index.ts:
```typescript
export { resolveCitations, DocumentResolver } from './resolve'
export type { ResolutionResult, ResolutionOptions, ResolvedCitation } from './resolve'
```

Follow existing export patterns from Phase 2 (convenience + granular + types).
  </action>
  <verify>
    npm run typecheck
    npm test -- extractShortForms --run
  </verify>
  <done>
extractId and extractSupra functions exist, extractCitations includes resolve option, SHORT_FORM_PATTERNS integrated into tokenization, resolution exports added to src/index.ts, TypeScript compilation succeeds, basic extraction tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests and update documentation</name>
  <files>
    tests/integration/resolution.test.ts
    README.md
  </files>
  <action>
**Part A: Create integration tests (tests/integration/resolution.test.ts)**

Validate end-to-end extraction → resolution workflow:

1. **Basic Id. resolution integration:**
   - Text: "See Smith v. Jones, 500 F.2d 123 (2020). Id. at 125."
   - Extract citations (should find 2: case + id)
   - Resolve citations
   - Verify Id. resolves to Smith v. Jones case
   - Verify resolution.confidence === 1.0

2. **Paragraph scope boundary:**
   - Text with two paragraphs (double newline separator)
   - First paragraph: "Smith v. Jones, 500 F.2d 123."
   - Second paragraph: "Id. at 125."
   - Resolve with paragraph scope (default)
   - Verify Id. fails to resolve (antecedent outside scope)
   - Verify resolution.failureReason contains "paragraph"

3. **Supra resolution with fuzzy matching:**
   - Text: "Smith, Inc. v. State, 600 F.3d 456 (2021). Later, Smith, supra, at 460."
   - Extract and resolve
   - Verify supra resolves to "Smith, Inc." case using fuzzy matching
   - Verify confidence >= 0.7 (fuzzy match confidence)

4. **Short-form case resolution:**
   - Text: "Brown v. Board, 347 U.S. 483 (1954). See also 347 U.S. at 495."
   - Extract and resolve
   - Verify short-form "347 U.S. at 495" resolves to Brown case
   - Verify volume and reporter match

5. **Convenience API (resolve option):**
   - Text with Id. and full case
   - Call extractCitations(text, { resolve: true })
   - Verify result is ResolvedCitation[] with resolution fields
   - Verify Id. citation has resolution.resolvedTo populated

6. **Unresolved citation warnings:**
   - Text: "Id. at 123." (no preceding citation)
   - Extract and resolve
   - Verify resolution.failureReason exists
   - Verify warnings array contains helpful message

7. **Parallel processing safety:**
   - Two different documents processed with Promise.all
   - Verify no state leakage between documents
   - Each Id. resolves to its own document's antecedent, not the other document's

Use realistic legal text examples. Follow integration test patterns from tests/integration/fullPipeline.test.ts (Phase 2).

**Part B: Update README documentation (README.md)**

Add comprehensive resolution documentation after existing extraction examples:

1. **Resolution section header:** "## Resolving Short-Form Citations"

2. **Explain what resolution does:**
   - Links Id., supra, short-form citations to their full antecedents
   - Respects paragraph scope boundaries by default
   - Returns warnings for unresolved citations

3. **Convenience API example:**
   ```typescript
   import { extractCitations } from 'eyecite-ts'

   const text = `Smith v. Jones, 500 F.2d 123 (2020). Id. at 125.`
   const citations = extractCitations(text, { resolve: true })

   for (const cite of citations) {
     if (cite.resolution?.resolvedTo) {
       console.log(`${cite.text} → ${cite.resolution.resolvedTo.text}`)
     }
   }
   ```

4. **Power-user API example:**
   ```typescript
   import { extractCitations, resolveCitations } from 'eyecite-ts'

   const citations = extractCitations(text)
   const resolved = resolveCitations(citations, {
     scopeStrategy: 'none',  // Allow Id. across entire document
     partyMatchThreshold: 0.7,  // Lower supra matching threshold
   })
   ```

5. **Resolution options table:**
   - scopeStrategy: paragraph (default), section, footnote, none
   - partyMatchThreshold: 0-1 (default 0.8)
   - fuzzyPartyMatching: boolean (default true)
   - reportUnresolved: boolean (default true)

6. **Handling unresolved citations example:**
   ```typescript
   const resolved = resolveCitations(citations)
   const unresolved = resolved.filter(c => !c.resolution?.resolvedTo)

   for (const cite of unresolved) {
     console.warn(`Unresolved: ${cite.text}`)
     console.warn(`Reason: ${cite.resolution?.failureReason}`)
   }
   ```

Insert resolution section after "Citation Extraction" section, before "Development" section. Keep examples concise and practical. Use TypeScript syntax highlighting.
  </action>
  <verify>
    npm test -- integration/resolution --run
    cat README.md | grep -q "resolveCitations"
  </verify>
  <done>
Integration tests pass validating Id./supra/short-form resolution, paragraph scope boundaries, convenience API, unresolved warnings, and parallel processing safety. README includes resolution section with examples, options table, and unresolved citation handling. All tests pass (139 existing + new resolution tests).
  </done>
</task>

</tasks>

<verification>
- [ ] extractId and extractSupra functions exported from src/extract/extractShortForms.ts
- [ ] extractCitations supports resolve option returning ResolvedCitation[]
- [ ] SHORT_FORM_PATTERNS integrated into tokenization pipeline
- [ ] Resolution API exported from src/index.ts
- [ ] Integration tests validate end-to-end extraction → resolution
- [ ] README documents resolution with examples and options
- [ ] All tests pass including new integration tests
- [ ] TypeScript strict mode compilation succeeds
</verification>

<success_criteria>
Developer can extract and resolve citations in one call using resolve option. Short-form citations (Id., supra) are extracted alongside full citations. Integration tests prove end-to-end workflow correctness. README guides developers through resolution API with practical examples. Phase 4 complete, v1.0 ready.
</success_criteria>

<output>
After completion, create `.planning/phases/04-short-form-resolution/04-04-SUMMARY.md`
</output>
