---
phase: 04-short-form-resolution
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/extract/extractShortForms.ts
  - src/tokenize/tokenize.ts
  - tests/unit/extract/extractShortForms.test.ts
autonomous: true

must_haves:
  truths:
    - "Tokenizer finds Id. citations in text"
    - "Tokenizer finds supra citations in text"
    - "Extraction creates SupraCitation objects with partyName field"
    - "Extraction creates IdCitation objects (already in types)"
    - "Extraction creates ShortFormCaseCitation objects"
    - "Pincites extracted from 'Id. at 253' and 'Smith, supra, at 460'"
  artifacts:
    - path: "src/extract/extractShortForms.ts"
      provides: "extractId, extractSupra, extractShortFormCase functions"
      exports: ["extractId", "extractSupra", "extractShortFormCase"]
    - path: "src/tokenize/tokenize.ts"
      provides: "SHORT_FORM_PATTERNS integrated into tokenizer"
      contains: "SHORT_FORM_PATTERNS"
    - path: "tests/unit/extract/extractShortForms.test.ts"
      provides: "Extraction tests for Id./supra/short-form"
      min_lines: 80
  key_links:
    - from: "src/extract/extractShortForms.ts"
      to: "src/types/citation.ts"
      via: "returns SupraCitation | IdCitation | ShortFormCaseCitation"
      pattern: "SupraCitation.*IdCitation.*ShortFormCaseCitation"
    - from: "src/tokenize/tokenize.ts"
      to: "src/patterns/shortForm.ts"
      via: "import SHORT_FORM_PATTERNS"
      pattern: "import.*SHORT_FORM_PATTERNS"
---

<objective>
Integrate short-form patterns into tokenizer and implement extraction functions that parse Id., supra, and short-form citations into typed Citation objects.

Purpose: Complete detection-to-extraction pipeline for short-form citations following Phase 2 architecture (broad tokenization, strict extraction).

Output: extractId/extractSupra/extractShortFormCase functions, tokenizer integration, comprehensive extraction tests.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-RESEARCH.md

Phase 2 architecture:
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/02-core-parsing/02-05-SUMMARY.md

Existing extraction functions:
@/Users/medelman/GitHub/medelman17/eyecitets/src/extract

Plan 01 output:
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate SHORT_FORM_PATTERNS into tokenizer</name>
  <files>src/tokenize/tokenize.ts</files>
  <action>
Add SHORT_FORM_PATTERNS to tokenizer's default pattern set.

1. Import SHORT_FORM_PATTERNS from patterns:
```typescript
import { SHORT_FORM_PATTERNS } from '../patterns/shortForm'
```

2. Update default patterns concatenation (follow TOKEN-04 decision from Phase 2):
Find the line where default patterns are concatenated (likely something like):
```typescript
const patterns = allPatterns ?? [
  ...casePatterns,
  ...statutePatterns,
  // ... other patterns
]
```

Add SHORT_FORM_PATTERNS to the array:
```typescript
const patterns = allPatterns ?? [
  ...casePatterns,
  ...statutePatterns,
  ...journalPatterns,
  ...neutralPatterns,
  ...publicLawPatterns,
  ...federalRegisterPatterns,
  ...SHORT_FORM_PATTERNS  // Add this
]
```

3. No other changes needed - tokenizer already handles multiple patterns per TOKEN-03 decision.

Why this works: Tokenizer is pattern-agnostic. Extraction layer (next task) handles type discrimination.
  </action>
  <verify>grep "SHORT_FORM_PATTERNS" src/tokenize/tokenize.ts returns import and usage</verify>
  <done>Tokenizer finds short-form citations using SHORT_FORM_PATTERNS alongside existing patterns</done>
</task>

<task type="auto">
  <name>Task 2: Implement extractId, extractSupra, extractShortFormCase</name>
  <files>src/extract/extractShortForms.ts, src/extract/index.ts</files>
  <action>
Create extraction functions for all three short-form citation types following Phase 2 extraction patterns.

1. Create src/extract/extractShortForms.ts with three extraction functions:

```typescript
import type { IdCitation, SupraCitation, ShortFormCaseCitation, Span } from '../types'
import { ID_PATTERN, SUPRA_PATTERN, SHORT_FORM_CASE_PATTERN } from '../patterns/shortForm'

/**
 * Extract Id. citation from token.
 * Confidence: 1.0 (unambiguous pattern)
 */
export function extractId(
  text: string,
  span: Span,
  processTimeMs: number = 0
): IdCitation | null {
  const match = text.match(ID_PATTERN) || text.match(/\b[Ii]bid\.\b/)
  if (!match) return null

  // Extract pincite if present: "Id. at 253"
  const pinciteMatch = text.match(/at\s+(\d+)/)
  const pincite = pinciteMatch ? parseInt(pinciteMatch[1], 10) : undefined

  return {
    type: 'id',
    text,
    span,
    confidence: 1.0,  // Id. is unambiguous
    matchedText: text,
    processTimeMs,
    patternsChecked: 1,
    pincite
  }
}

/**
 * Extract supra citation from token.
 * Confidence: 0.9 (high but not certain - party name matching happens in resolution)
 */
export function extractSupra(
  text: string,
  span: Span,
  processTimeMs: number = 0
): SupraCitation | null {
  const match = text.match(SUPRA_PATTERN)
  if (!match) return null

  const partyName = match[1]?.trim()
  if (!partyName) return null

  const pincite = match[2] ? parseInt(match[2], 10) : undefined

  return {
    type: 'supra',
    text,
    span,
    confidence: 0.9,
    matchedText: text,
    processTimeMs,
    patternsChecked: 1,
    partyName,
    pincite
  }
}

/**
 * Extract short-form case citation.
 * Confidence: 0.7 (requires validation against full citation history)
 */
export function extractShortFormCase(
  text: string,
  span: Span,
  processTimeMs: number = 0
): ShortFormCaseCitation | null {
  const match = text.match(SHORT_FORM_CASE_PATTERN)
  if (!match) return null

  const volume = parseInt(match[1], 10)
  const reporter = match[2]
  const pincite = match[3] ? parseInt(match[3], 10) : undefined

  return {
    type: 'shortFormCase',
    text,
    span,
    confidence: 0.7,  // Medium confidence until validated
    matchedText: text,
    processTimeMs,
    patternsChecked: 1,
    volume,
    reporter,
    pincite
  }
}
```

2. Export from src/extract/index.ts:
```typescript
export { extractId, extractSupra, extractShortFormCase } from './extractShortForms'
```

Follow Phase 2 conventions: return null if no match, processTimeMs parameter, confidence scoring per EXT-03/EXT-04 decisions.
  </action>
  <verify>npm run typecheck passes, grep "export function extractShortFormCase" src/extract/extractShortForms.ts returns function definition</verify>
  <done>extractId, extractSupra, extractShortFormCase functions create typed Citation objects from matched tokens</done>
</task>

<task type="auto">
  <name>Task 3: Create extraction tests for short-form citations</name>
  <files>tests/unit/extract/extractShortForms.test.ts</files>
  <action>
Create comprehensive extraction tests following Phase 2 test patterns.

Test structure:
1. extractId tests: "Id.", "Id. at 253", "Ibid.", null on non-Id
2. extractSupra tests: "Smith, supra", "Smith v. Jones, supra, at 460", party name extraction, pincite extraction
3. extractShortFormCase tests: "500 F.2d at 125", volume/reporter/pincite parsing
4. Confidence scoring tests: Id = 1.0, supra = 0.9, shortForm = 0.7
5. Edge cases: malformed input returns null, empty text returns null

Example tests:
```typescript
import { describe, it, expect } from 'vitest'
import { extractId, extractSupra, extractShortFormCase } from '@/extract/extractShortForms'
import type { Span } from '@/types'

const mockSpan: Span = {
  cleanStart: 0, cleanEnd: 10,
  originalStart: 0, originalEnd: 10
}

describe('extractId', () => {
  it('extracts simple Id. citation', () => {
    const result = extractId('Id.', mockSpan)
    expect(result).not.toBeNull()
    expect(result?.type).toBe('id')
    expect(result?.confidence).toBe(1.0)
    expect(result?.pincite).toBeUndefined()
  })

  it('extracts Id. with pincite', () => {
    const result = extractId('Id. at 253', mockSpan)
    expect(result?.pincite).toBe(253)
  })

  it('handles Ibid. variant', () => {
    const result = extractId('Ibid.', mockSpan)
    expect(result?.type).toBe('id')
  })

  it('returns null for non-Id text', () => {
    expect(extractId('Idaho', mockSpan)).toBeNull()
  })
})

describe('extractSupra', () => {
  it('extracts supra with party name', () => {
    const result = extractSupra('Smith, supra', mockSpan)
    expect(result?.type).toBe('supra')
    expect(result?.partyName).toBe('Smith')
    expect(result?.confidence).toBe(0.9)
  })

  it('extracts supra with pincite', () => {
    const result = extractSupra('Smith, supra, at 460', mockSpan)
    expect(result?.partyName).toBe('Smith')
    expect(result?.pincite).toBe(460)
  })
})

describe('extractShortFormCase', () => {
  it('extracts short-form case citation', () => {
    const result = extractShortFormCase('500 F.2d at 125', mockSpan)
    expect(result?.type).toBe('shortFormCase')
    expect(result?.volume).toBe(500)
    expect(result?.reporter).toBe('F.2d')
    expect(result?.pincite).toBe(125)
  })

  it('returns null for non-matching text', () => {
    expect(extractShortFormCase('random text', mockSpan)).toBeNull()
  })
})
```

Add more edge cases as needed. Follow Vitest conventions from Phase 2.
  </action>
  <verify>npm test tests/unit/extract/extractShortForms.test.ts passes all tests</verify>
  <done>Extraction tests validate Id./supra/short-form parsing, pincite extraction, confidence scoring, and null returns</done>
</task>

</tasks>

<verification>
1. npm run typecheck passes
2. npm test passes all short-form extraction tests
3. Tokenizer includes SHORT_FORM_PATTERNS in default set
4. extractId/extractSupra/extractShortFormCase return properly typed Citation objects
5. Confidence scores: Id = 1.0, supra = 0.9, shortFormCase = 0.7
</verification>

<success_criteria>
- Short-form patterns integrated into tokenizer pipeline
- Extraction functions parse Id./supra/short-form into typed objects
- All extraction tests pass validating parsing accuracy
- Ready for resolution engine implementation (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/04-short-form-resolution/04-02-SUMMARY.md`
</output>
