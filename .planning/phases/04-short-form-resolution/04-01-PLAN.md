---
phase: 04-short-form-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/citation.ts
  - src/patterns/shortForm.ts
  - tests/unit/patterns/shortForm.test.ts
autonomous: true

must_haves:
  truths:
    - "Developer can detect Id. citations in text"
    - "Developer can detect Ibid. citations in text"
    - "Developer can detect supra citations with party names in text"
    - "Id. pincite (Id. at 253) is extracted as separate field"
    - "All short-form patterns are ReDoS-safe (<100ms on pathological input)"
  artifacts:
    - path: "src/types/citation.ts"
      provides: "SupraCitation and ShortFormCaseCitation type definitions"
      min_lines: 30
      contains: "SupraCitation"
    - path: "src/patterns/shortForm.ts"
      provides: "SHORT_FORM_PATTERNS with Id./Ibid./supra regex"
      exports: ["SHORT_FORM_PATTERNS", "ID_PATTERN", "IBID_PATTERN", "SUPRA_PATTERN"]
    - path: "tests/unit/patterns/shortForm.test.ts"
      provides: "Pattern validation tests with ReDoS protection"
      min_lines: 50
  key_links:
    - from: "src/patterns/shortForm.ts"
      to: "src/types/citation.ts"
      via: "import SupraCitation"
      pattern: "import.*SupraCitation"
    - from: "tests/unit/patterns/shortForm.test.ts"
      to: "src/patterns/shortForm.ts"
      via: "import patterns"
      pattern: "import.*SHORT_FORM_PATTERNS"
---

<objective>
Implement short-form citation type definitions and ReDoS-safe detection patterns for Id., Ibid., and supra citations.

Purpose: Establish type system and pattern layer for short-form citations before implementing resolution logic. Follows Phase 2 pattern of separating detection from extraction.

Output: Two new citation types (SupraCitation, ShortFormCaseCitation), SHORT_FORM_PATTERNS exported from src/patterns/shortForm.ts, comprehensive pattern tests validating ReDoS safety.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-CONTEXT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/04-short-form-resolution/04-RESEARCH.md

Prior work from Phase 2:
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/02-core-parsing/02-02-SUMMARY.md

Existing patterns:
@/Users/medelman/GitHub/medelman17/eyecitets/src/patterns
@/Users/medelman/GitHub/medelman17/eyecitets/src/types/citation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SupraCitation and ShortFormCaseCitation types</name>
  <files>src/types/citation.ts, src/types/index.ts</files>
  <action>
Extend citation type system with supra and short-form case citations.

1. Add "supra" | "shortFormCase" to CitationType union (line 6)

2. Add SupraCitation interface after IdCitation:
```typescript
/**
 * Supra citation (refers to earlier citation by party name).
 * 
 * @example "Smith, supra"
 * @example "Smith, supra, at 460"
 */
export interface SupraCitation extends CitationBase {
  type: "supra"
  /** Party name extracted from citation text */
  partyName: string
  /** Specific page reference */
  pincite?: number
}
```

3. Add ShortFormCaseCitation interface after SupraCitation:
```typescript
/**
 * Short-form case citation (abbreviated reference to earlier full citation).
 * Distinguished from full case by lack of case name.
 * 
 * @example "500 F.2d at 125" (refers to earlier full citation at different page)
 */
export interface ShortFormCaseCitation extends CitationBase {
  type: "shortFormCase"
  volume: number
  reporter: string
  page?: number
  pincite?: number
}
```

4. Add both to Citation union type (line 233): `| SupraCitation | ShortFormCaseCitation`

5. Export from src/types/index.ts: SupraCitation, ShortFormCaseCitation

Follow existing convention: detailed JSDoc comments, optional fields with ?, same structure as other citation types.
  </action>
  <verify>npm run typecheck passes, grep "SupraCitation" src/types/citation.ts returns interface definition</verify>
  <done>SupraCitation and ShortFormCaseCitation types exist in Citation union with proper TypeScript discrimination</done>
</task>

<task type="auto">
  <name>Task 2: Create SHORT_FORM_PATTERNS with ReDoS protection</name>
  <files>src/patterns/shortForm.ts, src/patterns/index.ts</files>
  <action>
Create short-form detection patterns following Phase 2 PATTERN-02 decision (simple regex without nested quantifiers).

1. Create src/patterns/shortForm.ts with pattern objects:

```typescript
/**
 * Short-form citation patterns (Id., Ibid., supra).
 * ReDoS-safe: no nested quantifiers, tested <100ms on pathological input.
 */

/** Id. with optional pincite: "Id." or "Id. at 253" */
export const ID_PATTERN = /\b[Ii]d\.(?:\s+at\s+(\d+))?\b/g

/** Ibid. with optional pincite (less common variant) */
export const IBID_PATTERN = /\b[Ii]bid\.(?:\s+at\s+(\d+))?\b/g

/** 
 * Supra with party name and optional pincite.
 * Pattern: word(s), supra [, at page]
 * Captures: (1) party name, (2) pincite
 */
export const SUPRA_PATTERN = /\b([A-Z][a-zA-Z]+(?:\s+[a-zA-Z]+)*),?\s+supra(?:,?\s+at\s+(\d+))?\b/g

/**
 * Short-form case: volume reporter [at page]
 * Pattern: number space abbreviation [space "at" space number]
 * Simplified detection; full parsing in extraction layer
 */
export const SHORT_FORM_CASE_PATTERN = /\b(\d+)\s+([A-Z][a-z.]+\d*)\s+at\s+(\d+)\b/g

/** All short-form patterns for tokenization */
export const SHORT_FORM_PATTERNS = [
  ID_PATTERN,
  IBID_PATTERN,
  SUPRA_PATTERN,
  SHORT_FORM_CASE_PATTERN
]
```

2. Export from src/patterns/index.ts:
```typescript
export { 
  ID_PATTERN, 
  IBID_PATTERN, 
  SUPRA_PATTERN, 
  SHORT_FORM_CASE_PATTERN, 
  SHORT_FORM_PATTERNS 
} from './shortForm'
```

3. Follow Phase 2 conventions: individual named exports, simple regex structure, global flag for multiple matches.

Why simple patterns: Avoid ReDoS (PATTERN-02). Match broadly; extraction layer validates specifics.
  </action>
  <verify>grep "export const ID_PATTERN" src/patterns/shortForm.ts returns pattern definition</verify>
  <done>SHORT_FORM_PATTERNS exported with ReDoS-safe regex for Id./Ibid./supra/short-form detection</done>
</task>

<task type="auto">
  <name>Task 3: Create pattern validation tests with ReDoS protection</name>
  <files>tests/unit/patterns/shortForm.test.ts</files>
  <action>
Create comprehensive pattern tests following Phase 2 test patterns (02-02).

Test structure:
1. Basic pattern matching tests (Id., Id. at 253, Ibid., etc.)
2. Supra pattern tests with various party name formats
3. Short-form case pattern tests
4. Negative tests (should NOT match: "Idaho", "Idea", common false positives)
5. ReDoS protection test: pathological input completes in <100ms

Example test cases:
- "Id." matches ID_PATTERN
- "Id. at 253" extracts pincite 253
- "Ibid. at 125" matches IBID_PATTERN
- "Smith, supra" matches SUPRA_PATTERN and extracts "Smith"
- "Smith v. Jones, supra, at 460" extracts "Smith v. Jones" and 460
- "500 F.2d at 125" matches SHORT_FORM_CASE_PATTERN
- "Idaho" does NOT match ID_PATTERN (word boundary protection)
- Pathological input: repeated "Id. Id. Id. ..." (10,000 chars) parses in <100ms

Use Vitest it() blocks, expect().toMatch() and .not.toMatch() assertions.

Follow Phase 2 TEST-01 decision: 10-second timeout configured in vitest.config.ts for ReDoS validation.
  </action>
  <verify>npm test tests/unit/patterns/shortForm.test.ts passes all tests, ReDoS test completes <100ms</verify>
  <done>Pattern tests validate correct matching, false positive prevention, and ReDoS safety for all short-form patterns</done>
</task>

</tasks>

<verification>
1. npm run typecheck passes with no errors
2. npm test passes all pattern tests
3. grep "type.*supra.*shortFormCase" src/types/citation.ts confirms new types in union
4. ReDoS test validates all patterns <100ms on pathological input
5. Pattern exports available: import { SHORT_FORM_PATTERNS } from '@/patterns' works
</verification>

<success_criteria>
- SupraCitation and ShortFormCaseCitation types integrated into Citation discriminated union
- SHORT_FORM_PATTERNS exported from src/patterns/shortForm.ts with ReDoS protection
- All pattern tests pass validating detection accuracy and performance
- Type system ready for resolution engine implementation (Plan 02-03)
</success_criteria>

<output>
After completion, create `.planning/phases/04-short-form-resolution/04-01-SUMMARY.md`
</output>
