---
phase: 07-party-name-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/citation.ts
  - src/extract/extractCase.ts
  - tests/extract/extractCase.test.ts
autonomous: true

must_haves:
  truths:
    - "Standard adversarial cases (Smith v. Doe) produce plaintiff and defendant fields"
    - "Procedural cases (In re Smith) produce plaintiff only with proceduralPrefix"
    - "Government entity plaintiffs (People v., State v., United States v.) are recognized as plaintiffs, not procedural prefixes"
    - "Normalized fields strip et al., d/b/a, aka, corporate suffixes, and leading articles"
    - "Raw fields preserve original case name text exactly"
    - "All new fields are optional (backward compatible)"
  artifacts:
    - path: "src/types/citation.ts"
      provides: "plaintiffNormalized, defendantNormalized, proceduralPrefix fields on FullCaseCitation"
      contains: "plaintiffNormalized"
    - path: "src/extract/extractCase.ts"
      provides: "extractPartyNames() and normalizePartyName() functions"
      contains: "extractPartyNames"
    - path: "tests/extract/extractCase.test.ts"
      provides: "Party name extraction tests covering all scenarios"
      contains: "extractPartyNames"
  key_links:
    - from: "src/extract/extractCase.ts"
      to: "extractPartyNames result"
      via: "called after caseName extraction in extractCase()"
      pattern: "extractPartyNames\\(caseName\\)"
    - from: "src/extract/extractCase.ts"
      to: "FullCaseCitation return"
      via: "plaintiff/defendant/normalized fields spread into return object"
      pattern: "plaintiff|defendant|proceduralPrefix"
---

<objective>
Extract plaintiff and defendant party names from case citations, with raw and normalized fields.

Purpose: Enables structured party name access (PARTY-01, PARTY-02, PARTY-03) and prepares data for supra resolution improvement in Plan 02. Implements name splitting, procedural prefix handling, government entity recognition, normalization pipeline, and confidence adjustments.

Output: extractPartyNames() function in extractCase.ts, type extensions in citation.ts, comprehensive tests.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-party-name-extraction/07-CONTEXT.md
@.planning/phases/07-party-name-extraction/07-RESEARCH.md
@src/types/citation.ts
@src/extract/extractCase.ts
@tests/extract/extractCase.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type fields and implement extractPartyNames</name>
  <files>src/types/citation.ts, src/extract/extractCase.ts</files>
  <action>
**1. Extend FullCaseCitation in src/types/citation.ts:**

Add three new optional fields after the existing `defendant` field (lines ~137):

```typescript
/**
 * Normalized plaintiff name for matching (lowercase, stripped of noise).
 * Populated by Phase 7 (Party Name extraction).
 * @example "smith" from "The Smith Corp., Inc."
 */
plaintiffNormalized?: string

/**
 * Normalized defendant name for matching (lowercase, stripped of noise).
 * Populated by Phase 7 (Party Name extraction).
 * @example "doe" from "Doe et al."
 */
defendantNormalized?: string

/**
 * Procedural prefix for non-adversarial cases.
 * Populated by Phase 7 (Party Name extraction).
 * @example "In re" from "In re Smith"
 */
proceduralPrefix?: string
```

**2. Implement normalizePartyName() in src/extract/extractCase.ts:**

Add a function that applies this normalization pipeline:
1. Strip "et al." (case-insensitive, with or without period)
2. Strip "d/b/a" (case-insensitive)
3. Strip "aka" (case-insensitive, word boundary)
4. Strip trailing corporate suffixes: Inc., LLC, Corp., Ltd., Co., LLP, LP, P.C. (with or without trailing period)
5. Strip leading articles: "The", "A", "An" (only at start)
6. Normalize whitespace (collapse multiple spaces to single)
7. Trim
8. Lowercase

Do NOT strip government entity names (United States, People, Commonwealth, State). Do NOT reorder comma-based names. Do NOT strip standalone meaningful words.

**3. Implement extractPartyNames() in src/extract/extractCase.ts:**

Function signature:
```typescript
function extractPartyNames(caseName: string): {
  plaintiff?: string
  plaintiffNormalized?: string
  defendant?: string
  defendantNormalized?: string
  proceduralPrefix?: string
}
```

Logic (in order):

a) Check for procedural prefixes FIRST (anchored to start of caseName, case-insensitive):
   - Prefix set: "In re", "Ex parte", "Matter of", "State ex rel.", "United States ex rel.", "Application of", "Petition of", "Estate of"
   - BUT: If caseName contains "v." after the prefix, treat as adversarial (not procedural). Exception: "Estate of X v. Y" is adversarial with "Estate of X" as plaintiff.
   - For pure procedural (no "v."): plaintiff = full caseName text (e.g., "In re Smith"), plaintiffNormalized = normalizePartyName(subject only, after prefix), proceduralPrefix = matched prefix text.

b) Split on "v." or "vs." for adversarial cases:
   - Split on FIRST occurrence only (use indexOf/search, not split)
   - Regex: `/\s+v\.?\s+/i` to match "v.", "v", "vs.", "vs" with surrounding whitespace
   - plaintiff = text before match, trimmed (raw, no modification)
   - defendant = text after match, trimmed (raw, no modification)
   - plaintiffNormalized = normalizePartyName(plaintiff)
   - defendantNormalized = normalizePartyName(defendant)

c) If no "v." and no procedural prefix: return empty object (no parties extracted).

**4. Wire extractPartyNames into extractCase():**

After the caseName extraction block (around line 384-406), add:
```typescript
// Phase 7: Extract party names from case name
let plaintiff: string | undefined
let plaintiffNormalized: string | undefined
let defendant: string | undefined
let defendantNormalized: string | undefined
let proceduralPrefix: string | undefined

if (caseName) {
  const partyResult = extractPartyNames(caseName)
  plaintiff = partyResult.plaintiff
  plaintiffNormalized = partyResult.plaintiffNormalized
  defendant = partyResult.defendant
  defendantNormalized = partyResult.defendantNormalized
  proceduralPrefix = partyResult.proceduralPrefix
}
```

Add these fields to the return object (alongside existing caseName).

**5. Confidence adjustment (PARTY-05):**

Per research decisions: Do NOT lower citation confidence for missing party names (backward compatibility). The confidence scoring in extractCase() remains unchanged. Party name extraction quality will be reflected in supra resolution confidence (Plan 02), not in the citation's own confidence score.

No changes to the existing confidence scoring block.
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Run `pnpm exec vitest run tests/extract/extractCase.test.ts` to confirm existing tests still pass (backward compatibility).
  </verify>
  <done>
FullCaseCitation type has plaintiffNormalized, defendantNormalized, proceduralPrefix fields. extractPartyNames() function exists and is called from extractCase(). All existing tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Comprehensive party name extraction tests</name>
  <files>tests/extract/extractCase.test.ts</files>
  <action>
Add a new `describe('party name extraction')` block in tests/extract/extractCase.test.ts with these test groups:

**Standard adversarial cases (PARTY-01):**
- "Smith v. Jones" -> plaintiff: "Smith", defendant: "Jones"
- "Smith v. Jones" via extractCitations with cleanedText (integration-style: full text "Smith v. Jones, 500 F.2d 123 (2020)" -> citation has plaintiff/defendant fields)
- Raw fields preserve exact text: "The Smith Corp., Inc. v. Doe et al." -> plaintiff: "The Smith Corp., Inc.", defendant: "Doe et al."
- Normalized fields: same input -> plaintiffNormalized: "smith", defendantNormalized: "doe"

**Multiple "v." handling:**
- "People v. Smith v. Jones" -> split on FIRST "v.": plaintiff: "People", defendant: "Smith v. Jones"

**Procedural prefixes (PARTY-02):**
- "In re Smith" (no v.) -> plaintiff: "In re Smith", proceduralPrefix: "In re", no defendant
- "Ex parte Jones" -> plaintiff: "Ex parte Jones", proceduralPrefix: "Ex parte"
- "Matter of Johnson" -> plaintiff: "Matter of Johnson", proceduralPrefix: "Matter of"
- "Estate of Smith" (no v.) -> plaintiff: "Estate of Smith", proceduralPrefix: "Estate of"
- "Estate of Smith v. Jones" (with v.) -> adversarial: plaintiff: "Estate of Smith", defendant: "Jones", no proceduralPrefix
- Case-insensitive: "IN RE SMITH" -> proceduralPrefix: "IN RE" (raw preserved), plaintiffNormalized: "smith"

**Government entity plaintiffs (PARTY-03):**
- "United States v. Jones" -> plaintiff: "United States", defendant: "Jones" (NOT procedural)
- "People v. Smith" -> plaintiff: "People", defendant: "Smith" (NOT procedural)
- "Commonwealth v. Davis" -> plaintiff: "Commonwealth", defendant: "Davis"
- "State v. Miller" -> plaintiff: "State", defendant: "Miller"

**Normalization pipeline:**
- "Doe et al." -> normalized: "doe"
- "Smith d/b/a Smith Industries" -> normalized: "smith"
- "Jones aka Johnson" -> normalized: "jones"
- "The Ford Motor Co." -> normalized: "ford motor"
- "Apple Inc." -> normalized: "apple"
- "Microsoft Corp." -> normalized: "microsoft"
- "United States" -> normalized: "united states" (NOT stripped)
- "People" -> normalized: "people" (NOT stripped)

**Edge cases:**
- caseName is undefined -> no party fields set
- caseName with no "v." and no procedural prefix -> no party fields set
- Empty string caseName -> no party fields set

Use the existing test helpers (createIdentityMap). For integration-style tests that need cleanedText, use `extractCitations` from '@/extract' with full citation strings.
  </action>
  <verify>
Run `pnpm exec vitest run tests/extract/extractCase.test.ts` — all new and existing tests pass. Run `pnpm exec vitest run` — full suite passes (no regressions).
  </verify>
  <done>
Party name extraction tests cover: standard adversarial (PARTY-01), procedural prefixes (PARTY-02), government entities (PARTY-03), normalization pipeline, multiple "v." handling, and edge cases. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes (type extensions valid)
2. `pnpm exec vitest run tests/extract/extractCase.test.ts` passes (all party name tests)
3. `pnpm exec vitest run` passes (no regressions across full suite)
4. `pnpm lint` passes (code style)
</verification>

<success_criteria>
- FullCaseCitation has plaintiff, defendant, plaintiffNormalized, defendantNormalized, proceduralPrefix (all optional)
- extractPartyNames() correctly splits "v." cases into plaintiff/defendant
- Procedural prefixes (In re, Ex parte, etc.) produce plaintiff-only with proceduralPrefix field
- Government entities (People, State, Commonwealth, United States) treated as plaintiffs
- Normalized fields are lowercase, stripped of legal noise (et al., d/b/a, corporate suffixes, leading articles)
- Raw fields preserve original text exactly
- All existing tests pass unchanged (backward compatibility)
- New tests cover all five requirements (PARTY-01 through PARTY-05)
</success_criteria>

<output>
After completion, create `.planning/phases/07-party-name-extraction/07-01-SUMMARY.md`
</output>
