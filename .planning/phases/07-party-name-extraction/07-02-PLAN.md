---
phase: 07-party-name-extraction
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/resolve/DocumentResolver.ts
  - tests/integration/resolution.test.ts
autonomous: true

must_haves:
  truths:
    - "Supra resolution uses extracted plaintiff/defendant for matching before Levenshtein fallback"
    - "Party name direct match returns 1.0 confidence"
    - "Levenshtein fallback still works when party names not available"
    - "Defendant name preferred for supra matching (more distinctive per Bluebook)"
    - "Supra resolves correctly for procedural cases using plaintiffNormalized"
  artifacts:
    - path: "src/resolve/DocumentResolver.ts"
      provides: "Party name matching in trackFullCitation and resolveSupra"
      contains: "plaintiffNormalized"
    - path: "tests/integration/resolution.test.ts"
      provides: "Tests for party name supra resolution"
      contains: "party name"
  key_links:
    - from: "src/resolve/DocumentResolver.ts"
      to: "FullCaseCitation.plaintiffNormalized"
      via: "trackFullCitation reads extracted party names"
      pattern: "plaintiffNormalized|defendantNormalized"
    - from: "src/resolve/DocumentResolver.ts"
      to: "normalizedLevenshteinDistance"
      via: "Levenshtein fallback when party names unavailable"
      pattern: "normalizedLevenshteinDistance"
---

<objective>
Augment supra resolution to use extracted party names for faster, more accurate matching.

Purpose: Implements PARTY-04 (supra resolution uses party names, fixes #21) and PARTY-05 (confidence scoring). The current DocumentResolver extracts party names from raw text via backward regex search. With Phase 7 Plan 01 providing structured plaintiff/defendant fields, the resolver can use these directly for higher-confidence matching, falling back to the existing Levenshtein approach when party names are unavailable.

Output: Updated DocumentResolver with party name matching priority, updated resolution integration tests.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-party-name-extraction/07-CONTEXT.md
@.planning/phases/07-party-name-extraction/07-RESEARCH.md
@.planning/phases/07-party-name-extraction/07-01-SUMMARY.md
@src/resolve/DocumentResolver.ts
@src/resolve/types.ts
@src/resolve/levenshtein.ts
@src/types/citation.ts
@tests/integration/resolution.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Augment DocumentResolver with party name matching</name>
  <files>src/resolve/DocumentResolver.ts</files>
  <action>
**1. Update trackFullCitation() to use extracted party names:**

Currently, trackFullCitation() calls extractPartyName() which does its own backward regex search in the raw text. Replace this with a strategy that:

a) First, check if the citation has `plaintiffNormalized` or `defendantNormalized` fields (populated by Phase 7 extraction). If available, store BOTH in fullCitationHistory:
   - Store defendantNormalized -> index (preferred for supra matching per Bluebook)
   - Store plaintiffNormalized -> index (fallback)

b) If no extracted party names available (pre-Phase 7 citations or extraction failed), fall back to the existing extractPartyName() backward search.

The fullCitationHistory Map currently maps normalized party name -> index. This is fine. We just need to add multiple entries per citation when both plaintiff and defendant are available.

Modify trackFullCitation():
```typescript
private trackFullCitation(citation: Citation, index: number): void {
  if (citation.type === 'case') {
    // Phase 7: Use extracted party names when available
    if (citation.defendantNormalized) {
      this.context.fullCitationHistory.set(citation.defendantNormalized, index)
    }
    if (citation.plaintiffNormalized) {
      this.context.fullCitationHistory.set(citation.plaintiffNormalized, index)
    }

    // Fallback: backward search from text (pre-Phase 7 compatibility)
    if (!citation.plaintiffNormalized && !citation.defendantNormalized) {
      const partyName = this.extractPartyName(citation)
      if (partyName) {
        const normalized = this.normalizePartyName(partyName)
        this.context.fullCitationHistory.set(normalized, index)
      }
    }
  }
}
```

**2. Update resolveSupra() for confidence scoring (PARTY-05):**

The existing resolveSupra() already works with Levenshtein matching against fullCitationHistory. Since trackFullCitation() now stores normalized party names directly, the matching will be more precise.

The key confidence improvement: when a supra party name directly matches a defendant or plaintiff normalized name (similarity >= 0.95), the resolution is high-confidence. The existing Levenshtein logic handles this naturally since identical strings have similarity 1.0.

No structural changes needed to resolveSupra() itself -- the improvement comes from storing better-quality names in trackFullCitation(). The existing 0.8 threshold and Levenshtein similarity scoring remain correct.

**3. Keep the existing extractPartyName() and stripSignalWords() methods:**

These are the backward-search fallback for cases where Phase 7 extraction didn't populate party names. Do NOT remove them. They serve as a safety net.

**4. Keep normalizePartyName() in DocumentResolver as-is:**

The resolver's normalizePartyName() (lowercase + whitespace normalization) is used on the supra citation's partyName field. This remains needed because SupraCitation.partyName comes from the supra token text, not from extraction.

**Important:** The import of FullCaseCitation type may already be present. Verify and add if needed for the type narrowing `citation.type === 'case'` which already narrows to FullCaseCitation.
  </action>
  <verify>
Run `pnpm typecheck` to confirm no type errors. Run `pnpm exec vitest run tests/integration/resolution.test.ts` to confirm existing resolution tests still pass.
  </verify>
  <done>
DocumentResolver.trackFullCitation() uses extracted party names when available, falls back to backward search. Supra resolution benefits from higher-quality party name data. All existing resolution tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Party name supra resolution tests</name>
  <files>tests/integration/resolution.test.ts</files>
  <action>
Add a new `describe('Party Name Supra Resolution (#21)')` block in tests/integration/resolution.test.ts with these tests:

**Basic party name matching:**
- "Smith v. Jones, 500 F.2d 123 (2020). Jones, supra, at 130." -> supra resolves to case (defendant match)
- "Smith v. Jones, 500 F.2d 123 (2020). Smith, supra, at 130." -> supra resolves to case (plaintiff match)

**Government entity matching (PARTY-03 + PARTY-04):**
- "United States v. Jones, 500 F.2d 123 (2020). Jones, supra, at 130." -> resolves (defendant match)
- "People v. Smith, 200 F.3d 50 (2015). Smith, supra, at 55." -> resolves (defendant match)

**Procedural case matching (PARTY-02 + PARTY-04):**
- "In re Smith, 500 F.2d 123 (2020). Smith, supra, at 130." -> resolves (plaintiff normalized match against "smith")

**Confidence scoring (PARTY-05):**
- Exact party name match: confidence should be >= 0.95
- Fuzzy match (typo): confidence reflects Levenshtein similarity (< 1.0 but >= 0.8)

**Multiple citations with party names:**
- "Smith v. A, 100 F.2d 10 (2020). Jones v. B, 200 F.2d 20 (2021). Jones, supra." -> resolves to Jones v. B (index 1), not Smith v. A

**Backward compatibility:**
- Existing supra resolution tests still pass (tests already in file, just verify no regressions)
- Signal word stripping tests still pass

Use `extractCitations(text, { resolve: true })` pattern consistent with existing tests. Cast results as `ResolvedCitation[]`.
  </action>
  <verify>
Run `pnpm exec vitest run tests/integration/resolution.test.ts` — all new and existing tests pass. Run `pnpm exec vitest run` — full suite passes.
  </verify>
  <done>
Party name supra resolution tests cover: defendant matching, plaintiff matching, government entities, procedural cases, confidence scoring, multiple citations, and backward compatibility. All tests pass. Issue #21 is addressed.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm exec vitest run tests/integration/resolution.test.ts` passes (all resolution tests)
3. `pnpm exec vitest run` passes (no regressions across full suite)
4. `pnpm lint` passes
5. Supra resolution prefers extracted party names over backward text search
</verification>

<success_criteria>
- DocumentResolver uses extracted plaintiff/defendant names for supra matching
- Defendant name stored first (preferred for Bluebook-style supra matching)
- Both plaintiff and defendant stored in fullCitationHistory for flexible matching
- Fallback to backward text search when extracted names unavailable
- Exact party name match yields high confidence (>= 0.95)
- Procedural case supra matching works via plaintiffNormalized
- All existing resolution tests pass unchanged
- New tests verify party name matching for standard, government, and procedural cases
</success_criteria>

<output>
After completion, create `.planning/phases/07-party-name-extraction/07-02-SUMMARY.md`
</output>
