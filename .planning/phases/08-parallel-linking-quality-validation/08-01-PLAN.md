---
phase: 08-parallel-linking-quality-validation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/extract/detectParallel.ts
  - src/types/citation.ts
  - src/extract/extractCitations.ts
  - tests/extract/detectParallel.test.ts
  - tests/extract/extractCitations.test.ts
autonomous: true

must_haves:
  truths:
    - "Comma-separated case citations sharing a parenthetical are detected as parallel"
    - "groupId field identifies all citations in the same parallel group"
    - "parallelCitations array contains references to secondary reporters"
    - "All citations returned individually in results (backward compatible)"
    - "Shared fullSpan extends from first case name through final closing parenthetical"
  artifacts:
    - path: "src/extract/detectParallel.ts"
      provides: "Pure detection function for parallel citation groups"
      exports: ["detectParallelCitations"]
      min_lines: 80
    - path: "src/types/citation.ts"
      provides: "groupId field added to FullCaseCitation"
      contains: "groupId?: string"
    - path: "src/extract/extractCitations.ts"
      provides: "Parallel detection integrated into extraction pipeline"
      pattern: "detectParallelCitations"
    - path: "tests/extract/detectParallel.test.ts"
      provides: "Detection algorithm test coverage"
      min_lines: 150
  key_links:
    - from: "src/extract/extractCitations.ts"
      to: "src/extract/detectParallel.ts"
      via: "detection call after deduplication, before extraction loop"
      pattern: "detectParallelCitations\\(tokens"
    - from: "src/extract/detectParallel.ts"
      to: "token positions"
      via: "proximity analysis (comma separator + shared parenthetical)"
      pattern: "token\\.cleanEnd.*token\\.cleanStart"
    - from: "src/extract/extractCitations.ts"
      to: "citation.groupId"
      via: "groupId population from detection map"
      pattern: "groupId.*=.*groupIdMap"
---

<objective>
Detect and link parallel citations (same case in multiple reporters) using TDD methodology.

Purpose: Parallel citation linking is a core legal citation feature — practitioners expect citation tools to recognize when "410 U.S. 113, 93 S. Ct. 705, 35 L. Ed. 2d 147" refers to one case, not three. This enables downstream tools to group, deduplicate, and cross-reference parallel reporters.

Output: Pure detection function with comprehensive test coverage, integrated into extraction pipeline with groupId and parallelCitations fields populated.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/08-parallel-linking-quality-validation/08-CONTEXT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/08-parallel-linking-quality-validation/08-RESEARCH.md

# Prior phase outputs
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/07-party-name-extraction/07-02-SUMMARY.md

# Relevant source files
@/Users/medelman/GitHub/medelman17/eyecitets/src/types/citation.ts
@/Users/medelman/GitHub/medelman17/eyecitets/src/extract/extractCitations.ts
@/Users/medelman/GitHub/medelman17/eyecitets/src/extract/extractCase.ts
</context>

<feature>
  <name>Parallel Citation Detection</name>
  <files>
    src/extract/detectParallel.ts
    tests/extract/detectParallel.test.ts
  </files>

  <behavior>
    **Input:** Array of tokenized citations (from tokenize pipeline, after deduplication)

    **Output:** Map<primaryIndex, secondaryIndices[]> identifying parallel groups

    **Detection rules (per 08-RESEARCH.md):**
    1. **Separator:** Comma only (Bluebook standard)
    2. **Citation types:** Case citations only (no statutes, journals, etc.)
    3. **Shared context:** Citations must share a closing parenthetical (court, year, or both)
    4. **Proximity:** Secondary citation must start within 5 characters after primary's comma
    5. **No false positives:** Different cases separated by comma are NOT parallel (require shared parenthetical)

    **Test cases:**

    ```typescript
    // POSITIVE CASES

    // Standard parallel (3 reporters, shared year)
    "410 U.S. 113, 93 S. Ct. 705, 35 L. Ed. 2d 147 (1973)"
    → Map { 0 => [1, 2] }  // 0 = U.S., 1 = S. Ct., 2 = L. Ed.

    // Two reporters
    "500 F.2d 123, 200 F. Supp. 456 (9th Cir. 1974)"
    → Map { 0 => [1] }

    // Shared court only (no year)
    "100 F.2d 10, 50 F. Supp. 20 (S.D.N.Y.)"
    → Map { 0 => [1] }

    // Shared year only (no court)
    "10 Cal. 3d 100, 500 P.2d 200 (1970)"
    → Map { 0 => [1] }

    // NEGATIVE CASES (not parallel)

    // Different cases separated by comma (no shared parenthetical)
    "Smith v. Jones, 500 F.2d 100 (1974), and Doe v. Roe, 600 F.2d 200 (1975)"
    → Map {}  // Empty - different cases

    // Same case but semicolon separator (not comma)
    "500 F.2d 123; 200 F. Supp. 456 (1974)"
    → Map {}  // Phase 8 supports comma only

    // Statute followed by case (different citation types)
    "42 U.S.C. § 1983, 500 F.2d 100 (1974)"
    → Map {}  // Statute not a case citation

    // Wide separation (>5 chars after comma)
    "500 F.2d 123,      200 F. Supp. 456 (1974)"  // Wide spacing
    → Map {}  // Exceeds proximity threshold
    ```
  </behavior>

  <implementation>
    **RED phase:**

    1. Create `tests/extract/detectParallel.test.ts` with test suite covering:
       - Positive cases: 2-reporter, 3-reporter, shared court, shared year, shared both
       - Negative cases: different cases, semicolon separator, statute mixing, wide separation
       - Edge cases: empty array, single citation, no case citations

    2. Run `pnpm test tests/extract/detectParallel.test.ts` — MUST fail (function doesn't exist yet)

    3. Commit: `test(08-01): add failing tests for parallel citation detection`

    **GREEN phase:**

    1. Create `src/extract/detectParallel.ts` with:
       ```typescript
       import type { Token } from '@/tokenize/types'

       /**
        * Detect parallel citation groups from tokenized citations.
        *
        * Returns a map of primary citation index to secondary citation indices.
        * Parallel citations are comma-separated case citations sharing a parenthetical.
        *
        * @param tokens - Tokenized citations (after deduplication)
        * @returns Map of primary index to array of secondary indices
        */
       export function detectParallelCitations(tokens: Token[]): Map<number, number[]> {
         // Implementation here
       }
       ```

    2. Detection algorithm:
       - Iterate tokens with lookahead (i, i+1, i+2...)
       - Check if token[i] is case type
       - Check if comma separates token[i] and token[i+1] (within 5 chars)
       - Check if token[i+1] is case type
       - Find shared closing parenthetical (scan forward from token[i] end to find "(...)")
       - If shared parenthetical found, add to map: map.set(i, [...existing, i+1])
       - Continue for chain (i+1, i+2, i+3...) until no more matches

    3. Add `groupId?: string` field to FullCaseCitation in `src/types/citation.ts` (after line 78)

    4. Integrate detection into `src/extract/extractCitations.ts`:
       - Import detectParallelCitations
       - Call after deduplication (`const uniqueTokens = ...`), before extraction loop
       - Create `groupIdMap: Map<number, string>` and `parallelMap: Map<number, number[]>` from detection result
       - groupId format: `${volume}-${reporter}-${page}` (deterministic, stable)
       - During extraction loop, check if citation index is in groupIdMap:
         - If YES: assign groupId, populate parallelCitations array from parallelMap
         - If primary (map key): populate parallelCitations from secondary indices
         - If secondary (in map value): DO NOT populate parallelCitations (only primary gets array)
       - Share fullSpan: if citation is in parallel group, extend fullSpan to cover ALL citations through final parenthetical

    5. Run `pnpm test tests/extract/detectParallel.test.ts` — MUST pass

    6. Run full test suite `pnpm test` — ensure no regressions

    7. Commit: `feat(08-01): implement parallel citation detection with groupId and parallelCitations`

    **REFACTOR phase:**

    1. Review detection algorithm for clarity:
       - Extract helper functions if >100 lines
       - Add inline comments for proximity/parenthetical logic
       - Ensure no regex ReDoS risks

    2. Add integration test in `tests/extract/extractCitations.test.ts`:
       ```typescript
       it('links parallel citations with groupId and parallelCitations array', () => {
         const text = "See 410 U.S. 113, 93 S. Ct. 705 (1973)."
         const citations = extractCitations(text)
         expect(citations).toHaveLength(2)

         const primary = citations[0]
         expect(primary.groupId).toBe('410-U.S.-113')
         expect(primary.parallelCitations).toHaveLength(1)
         expect(primary.parallelCitations[0]).toEqual({
           volume: 93,
           reporter: 'S. Ct.',
           page: 705
         })

         const secondary = citations[1]
         expect(secondary.groupId).toBe('410-U.S.-113')  // Same group
         expect(secondary.parallelCitations).toBeUndefined()  // Only primary gets array
       })
       ```

    3. Run full test suite `pnpm test` — MUST pass

    4. Run `pnpm typecheck` and `pnpm lint` — MUST pass

    5. Commit (if changes made): `refactor(08-01): clean up parallel detection algorithm`
  </implementation>
</feature>

<verification>
Run test suite with coverage:
```bash
pnpm exec vitest run tests/extract/detectParallel.test.ts
pnpm exec vitest run tests/extract/extractCitations.test.ts
pnpm test
pnpm typecheck
pnpm lint
```

All tests MUST pass. No regressions in existing test suite.
</verification>

<success_criteria>
- ✅ `detectParallelCitations()` function exists and passes all unit tests
- ✅ `groupId` field added to FullCaseCitation type
- ✅ Parallel citations share the same groupId value
- ✅ Primary citation has parallelCitations array with secondary reporter metadata
- ✅ Secondary citations have NO parallelCitations array (only primary enriched)
- ✅ All citations returned individually in results (backward compatible)
- ✅ Shared fullSpan extends from first case name through final parenthetical
- ✅ No false positives (different cases with comma separator not linked)
- ✅ Integration test verifies end-to-end parallel linking
- ✅ All existing tests pass (no regressions)
- ✅ Zero type errors, zero lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-parallel-linking-quality-validation/08-01-SUMMARY.md`
</output>
