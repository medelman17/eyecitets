---
phase: 08-parallel-linking-quality-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/annotate/types.ts
  - src/annotate/annotate.ts
  - tests/annotate/annotate.test.ts
autonomous: true

must_haves:
  truths:
    - "Annotation supports useFullSpan option for full citation span mode"
    - "When useFullSpan enabled and citation has fullSpan, annotation spans case name through parenthetical"
    - "When useFullSpan disabled or fullSpan missing, annotation uses core span (backward compatible)"
    - "Parallel citation groups can be annotated together or individually (developer choice)"
  artifacts:
    - path: "src/annotate/types.ts"
      provides: "useFullSpan field in AnnotationOptions"
      contains: "useFullSpan?: boolean"
    - path: "src/annotate/annotate.ts"
      provides: "Full span annotation logic"
      pattern: "useFullSpan.*fullSpan"
      min_lines: 200
    - path: "tests/annotate/annotate.test.ts"
      provides: "Full span annotation test coverage"
      pattern: "useFullSpan.*fullSpan"
  key_links:
    - from: "src/annotate/annotate.ts"
      to: "citation.fullSpan"
      via: "conditional span selection based on useFullSpan option"
      pattern: "useFullSpan.*fullSpan.*span"
    - from: "src/annotate/annotate.ts"
      to: "AnnotationOptions.useFullSpan"
      via: "options destructuring"
      pattern: "useFullSpan.*=.*options"
---

<objective>
Add full-span annotation mode to annotate from case name through closing parenthetical.

Purpose: Full-span annotation enables rich UI highlighting — developers can highlight the entire citation context (case name + reporter + court/year) rather than just the core "volume-reporter-page" portion. This improves readability in legal document viewers and citation analysis tools.

Output: Extended AnnotationOptions with useFullSpan flag, annotate() updated to use fullSpan when available and requested, comprehensive test coverage.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/PROJECT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/ROADMAP.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/STATE.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/08-parallel-linking-quality-validation/08-CONTEXT.md
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/08-parallel-linking-quality-validation/08-RESEARCH.md

# Prior phase outputs
@/Users/medelman/GitHub/medelman17/eyecitets/.planning/phases/06-full-span-complex-parentheticals/06-02-SUMMARY.md

# Relevant source files
@/Users/medelman/GitHub/medelman17/eyecitets/src/annotate/types.ts
@/Users/medelman/GitHub/medelman17/eyecitets/src/annotate/annotate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend AnnotationOptions with useFullSpan option</name>
  <files>
    src/annotate/types.ts
  </files>
  <action>
Add `useFullSpan` field to AnnotationOptions interface (after line 57, before the `callback` field):

```typescript
  /**
   * Use full citation span from case name through parenthetical (true) or core citation only (false).
   *
   * When enabled and citation has a fullSpan field (from Phase 6+), annotation will span:
   * - Case name: "Smith v. Jones"
   * - Reporter: "500 F.2d 123"
   * - Parenthetical: "(9th Cir. 1974)"
   *
   * When disabled or fullSpan unavailable, falls back to core citation span (volume-reporter-page).
   *
   * **Use cases:**
   * - Rich UI highlighting: show full context in document viewers
   * - Parallel citation grouping: annotate entire parallel group together
   * - Citation analysis: visualize complete citation structure
   *
   * @default false (backward compatible)
   */
  useFullSpan?: boolean
```

Per 08-CONTEXT.md user decision: "Claude's discretion on activation API (options param vs separate function)" — using options param pattern for consistency with existing useCleanText/autoEscape options.

Run `pnpm typecheck` to verify no type errors.

Commit: `feat(08-02): add useFullSpan option to AnnotationOptions`
  </action>
  <verify>
```bash
pnpm typecheck
grep -n "useFullSpan" src/annotate/types.ts
```
Field exists in AnnotationOptions interface with JSDoc comment.
  </verify>
  <done>
useFullSpan field added to AnnotationOptions with documentation, typecheck passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement full-span annotation logic</name>
  <files>
    src/annotate/annotate.ts
  </files>
  <action>
Update annotate() function to support useFullSpan mode:

1. **Destructure useFullSpan from options** (line 53, after autoEscape):
   ```typescript
   const {
     useCleanText = false,
     autoEscape = true,
     useFullSpan = false,  // NEW: default false for backward compatibility
     template,
     callback,
   } = options
   ```

2. **Conditional span selection** (replace lines 72-73):
   ```typescript
   // Determine which span to use
   let start: number
   let end: number

   if (useFullSpan && 'fullSpan' in citation && citation.fullSpan) {
     // Full span mode: case name through parenthetical
     start = useCleanText ? citation.fullSpan.cleanStart : citation.fullSpan.originalStart
     end = useCleanText ? citation.fullSpan.cleanEnd : citation.fullSpan.originalEnd
   } else {
     // Default mode: core citation only
     start = useCleanText ? citation.span.cleanStart : citation.span.originalStart
     end = useCleanText ? citation.span.cleanEnd : citation.span.originalEnd
   }
   ```

3. **Update JSDoc** (line 5-47): Add useFullSpan to the "Supports two modes" section:
   ```typescript
   * Supports annotation modes:
   * - **Span mode**: Core citation (default) or full span with case name/parenthetical (useFullSpan: true)
   * - **Template mode**: Simple before/after wrapping (set `options.template`)
   * - **Callback mode**: Custom logic with full citation context (set `options.callback`)
   ```

4. **Add example** (after line 37):
   ```typescript
   * @example Full span mode
   * ```typescript
   * const result = annotate(text, citations, {
   *   useFullSpan: true,
   *   template: { before: '<mark class="full">', after: '</mark>' }
   * })
   * // Result: "<mark class="full">Smith v. Jones, 500 F.2d 123 (1974)</mark>"
   * ```
   ```

Per 08-CONTEXT.md: "Claude's discretion on whether parallel group gets one wrapper annotation or individual annotations" — implemented as individual annotations (each citation annotated separately). Developers can deduplicate using groupId in callback if desired.

Run `pnpm typecheck` and `pnpm lint` to verify clean code.

Commit: `feat(08-02): implement full-span annotation logic`
  </action>
  <verify>
```bash
pnpm typecheck
pnpm lint
grep -A 5 "useFullSpan" src/annotate/annotate.ts | head -20
```
useFullSpan logic exists, typecheck passes, lint passes.
  </verify>
  <done>
annotate() supports useFullSpan option with conditional span selection, backward compatible default, JSDoc updated.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add full-span annotation tests</name>
  <files>
    tests/annotate/annotate.test.ts
  </files>
  <action>
Add test coverage for useFullSpan mode at the end of the test suite (after existing tests):

```typescript
describe('useFullSpan mode', () => {
  it('uses fullSpan when available and useFullSpan enabled', () => {
    const text = "See Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)."
    const mockCitation: FullCaseCitation = {
      type: 'case',
      text: '500 F.2d 123',
      volume: 500,
      reporter: 'F.2d',
      page: 123,
      span: { cleanStart: 24, cleanEnd: 36, originalStart: 24, originalEnd: 36 },
      fullSpan: { cleanStart: 4, cleanEnd: 47, originalStart: 4, originalEnd: 47 },
      confidence: 1.0,
      matchedText: '500 F.2d 123',
      processTimeMs: 0,
      patternsChecked: 1,
    }

    const result = annotate(text, [mockCitation], {
      useFullSpan: true,
      template: { before: '<mark>', after: '</mark>' }
    })

    // Should wrap from "Smith" to "1974)"
    expect(result.text).toBe("See <mark>Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)</mark>.")
  })

  it('falls back to core span when fullSpan missing', () => {
    const text = "See Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)."
    const mockCitation: FullCaseCitation = {
      type: 'case',
      text: '500 F.2d 123',
      volume: 500,
      reporter: 'F.2d',
      page: 123,
      span: { cleanStart: 24, cleanEnd: 36, originalStart: 24, originalEnd: 36 },
      // NO fullSpan field
      confidence: 1.0,
      matchedText: '500 F.2d 123',
      processTimeMs: 0,
      patternsChecked: 1,
    }

    const result = annotate(text, [mockCitation], {
      useFullSpan: true,  // Requested but citation lacks fullSpan
      template: { before: '<cite>', after: '</cite>' }
    })

    // Should fall back to core span
    expect(result.text).toBe("See Smith v. Jones, <cite>500 F.2d 123</cite> (9th Cir. 1974).")
  })

  it('uses core span when useFullSpan disabled (default)', () => {
    const text = "See Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)."
    const mockCitation: FullCaseCitation = {
      type: 'case',
      text: '500 F.2d 123',
      volume: 500,
      reporter: 'F.2d',
      page: 123,
      span: { cleanStart: 24, cleanEnd: 36, originalStart: 24, originalEnd: 36 },
      fullSpan: { cleanStart: 4, cleanEnd: 47, originalStart: 4, originalEnd: 47 },
      confidence: 1.0,
      matchedText: '500 F.2d 123',
      processTimeMs: 0,
      patternsChecked: 1,
    }

    const result = annotate(text, [mockCitation], {
      // useFullSpan: false (default)
      template: { before: '<cite>', after: '</cite>' }
    })

    // Should use core span (backward compatible)
    expect(result.text).toBe("See Smith v. Jones, <cite>500 F.2d 123</cite> (9th Cir. 1974).")
  })

  it('works with callback mode and useFullSpan', () => {
    const text = "See Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)."
    const mockCitation: FullCaseCitation = {
      type: 'case',
      text: '500 F.2d 123',
      volume: 500,
      reporter: 'F.2d',
      page: 123,
      span: { cleanStart: 24, cleanEnd: 36, originalStart: 24, originalEnd: 36 },
      fullSpan: { cleanStart: 4, cleanEnd: 47, originalStart: 4, originalEnd: 47 },
      confidence: 1.0,
      matchedText: '500 F.2d 123',
      processTimeMs: 0,
      patternsChecked: 1,
    }

    const result = annotate(text, [mockCitation], {
      useFullSpan: true,
      callback: (citation) => {
        if (citation.type === 'case') {
          return `<a href="/cases/${citation.volume}-${citation.page}" class="full-cite">${citation.matchedText}</a>`
        }
        return citation.matchedText
      }
    })

    // Callback should receive citation but annotate full span
    expect(result.text).toContain('<a href="/cases/500-123"')
    expect(result.text).toContain('class="full-cite"')
  })
})
```

Run full test suite to ensure no regressions.

Commit: `test(08-02): add full-span annotation test coverage`
  </action>
  <verify>
```bash
pnpm exec vitest run tests/annotate/annotate.test.ts
pnpm test
pnpm typecheck
pnpm lint
```
All tests pass, no regressions, zero type errors.
  </verify>
  <done>
4 new tests cover useFullSpan mode: enabled with fullSpan, fallback when missing, disabled default, callback mode. All tests pass.
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
pnpm test
pnpm typecheck
pnpm lint
```

All tests MUST pass. Zero type errors. Zero lint errors (or only pre-existing warnings).

Manual verification:
```typescript
import { extractCitations } from 'eyecite-ts'
import { annotate } from 'eyecite-ts/annotate'

const text = "See Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)."
const citations = extractCitations(text)

// Core span mode (default)
const coreResult = annotate(text, citations, {
  template: { before: '<cite>', after: '</cite>' }
})
// Expected: "See Smith v. Jones, <cite>500 F.2d 123</cite> (9th Cir. 1974)."

// Full span mode
const fullResult = annotate(text, citations, {
  useFullSpan: true,
  template: { before: '<mark>', after: '</mark>' }
})
// Expected: "See <mark>Smith v. Jones, 500 F.2d 123 (9th Cir. 1974)</mark>."
```
</verification>

<success_criteria>
- ✅ useFullSpan field added to AnnotationOptions interface
- ✅ annotate() checks useFullSpan option and citation.fullSpan availability
- ✅ When useFullSpan enabled and fullSpan present, annotation spans case name through parenthetical
- ✅ When useFullSpan disabled or fullSpan missing, annotation uses core span (backward compatible)
- ✅ Default behavior unchanged (useFullSpan: false) — 100% backward compatible
- ✅ Works with both template and callback modes
- ✅ 4 new tests cover all paths (enabled, fallback, disabled, callback)
- ✅ All existing tests pass (no regressions)
- ✅ Zero type errors, zero lint errors
- ✅ JSDoc documents useFullSpan option with examples
</success_criteria>

<output>
After completion, create `.planning/phases/08-parallel-linking-quality-validation/08-02-SUMMARY.md`
</output>
