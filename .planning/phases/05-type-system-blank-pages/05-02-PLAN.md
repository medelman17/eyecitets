---
phase: 05-type-system-blank-pages
plan: 02
type: tdd
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/patterns/casePatterns.ts
  - src/extract/extractCase.ts
  - tests/extract/extractCase.test.ts
autonomous: true

must_haves:
  truths:
    - "Citations with ___ or --- as page produce hasBlankPage: true"
    - "Blank-page citations have page === undefined"
    - "Blank-page citations have confidence === 0.8"
    - "Normal citations are completely unaffected by blank page changes"
    - "Tokenizer matches blank-page citations (___/--- in page position)"
  artifacts:
    - path: "src/patterns/casePatterns.ts"
      provides: "Extended regex patterns matching blank page placeholders"
      contains: "___"
    - path: "src/extract/extractCase.ts"
      provides: "Blank page detection and hasBlankPage flag setting"
      contains: "hasBlankPage"
    - path: "tests/extract/extractCase.test.ts"
      provides: "Blank page extraction tests"
      contains: "blank page"
  key_links:
    - from: "src/patterns/casePatterns.ts"
      to: "src/extract/extractCase.ts"
      via: "Token with blank page text flows to extractor"
      pattern: "___"
    - from: "src/extract/extractCase.ts"
      to: "src/types/citation.ts"
      via: "Sets hasBlankPage and leaves page undefined"
      pattern: "hasBlankPage"
---

<objective>
Implement blank page placeholder recognition in case citations using TDD.

Purpose: Legal citations sometimes use placeholder pages (___/---) when the exact page is unknown. This plan adds tokenization + extraction support so these citations are properly captured with `hasBlankPage: true`, `page: undefined`, and `confidence: 0.8`.

Output: Working blank page recognition with comprehensive test coverage.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-type-system-blank-pages/05-01-SUMMARY.md
@src/types/citation.ts
@src/patterns/casePatterns.ts
@src/extract/extractCase.ts
@tests/extract/extractCase.test.ts
</context>

<feature>
  <name>Blank Page Placeholder Recognition</name>
  <files>src/patterns/casePatterns.ts, src/extract/extractCase.ts, tests/extract/extractCase.test.ts</files>
  <behavior>
  Inputs and expected outputs:

  1. "500 F.2d ___" → { type: "case", volume: 500, reporter: "F.2d", page: undefined, hasBlankPage: true, confidence: 0.8 }
  2. "500 F.2d ---" → { type: "case", volume: 500, reporter: "F.2d", page: undefined, hasBlankPage: true, confidence: 0.8 }
  3. "410 U.S. ____" → { type: "case", volume: 410, reporter: "U.S.", page: undefined, hasBlankPage: true, confidence: 0.8 }
  4. "410 U.S. ----" → { type: "case", volume: 410, reporter: "U.S.", page: undefined, hasBlankPage: true, confidence: 0.8 }
  5. "500 F.2d 123" → { page: 123, hasBlankPage: undefined, confidence: >= 0.8 } (unchanged)
  6. "500 F.2d ___ (2020)" → { hasBlankPage: true, year: 2020, confidence: 0.8 } (with parenthetical)
  7. "100 Cal.App.4th ___" → { hasBlankPage: true } (state reporter)

  Edge cases:
  - Single underscore "_" should NOT match (too short, not a placeholder pattern)
  - Single dash "-" should NOT match (too short)
  - Numeric pages NEVER set hasBlankPage
  </behavior>
  <implementation>
  **RED phase** - Write failing tests:

  Add a new `describe('blank page placeholders (BLANK-01 through BLANK-04)')` block to `tests/extract/extractCase.test.ts` with tests for all the input/output pairs above.

  **GREEN phase** - Implement to make tests pass:

  1. **Extend regex patterns** in `src/patterns/casePatterns.ts`:
     - In each pattern (federal-reporter, supreme-court, state-reporter), change the page capture group from `(\d+)` to `(\d+|_{3,}|-{3,})`.
     - The `{3,}` quantifier ensures we only match 3+ consecutive underscores/dashes (avoiding false matches on hyphens in reporter names).
     - The `\b` word boundary at the end stays. Underscores and dashes are non-word characters so `\b` works correctly after them.
     - IMPORTANT: Only change the LAST `(\d+)` in each pattern (the page capture group), NOT the volume group.

  2. **Update extraction logic** in `src/extract/extractCase.ts`:
     a. Update `volumeReporterPageRegex` from `(\d+)` (page group) to `(\d+|_{3,}|-{3,})` to match what the tokenizer now produces.
     b. After the regex match, check if the page match group is a blank placeholder:
        ```typescript
        const pageStr = match[3]
        const isBlankPage = /^[_-]{3,}$/.test(pageStr)
        const page = isBlankPage ? undefined : Number.parseInt(pageStr, 10)
        const hasBlankPage = isBlankPage ? true : undefined
        ```
     c. Override confidence for blank page citations:
        After the normal confidence calculation, add:
        ```typescript
        if (hasBlankPage) {
          confidence = 0.8
        }
        ```
     d. Add `hasBlankPage` to the return object (only when it's true; leave undefined for normal citations).

  **REFACTOR phase** - Clean up if needed. The implementation should be clean from the start.
  </implementation>
</feature>

<verification>
1. `pnpm exec vitest run tests/extract/extractCase.test.ts` -- all blank page tests pass
2. `pnpm exec vitest run` -- ALL tests pass (no regressions)
3. `pnpm typecheck` -- no type errors
4. `pnpm lint` -- no lint errors
5. Blank page citations have: hasBlankPage === true, page === undefined, confidence === 0.8
6. Normal citations unchanged: page is numeric, hasBlankPage is undefined
</verification>

<success_criteria>
- BLANK-01: `___`, `---`, `____`, `----` recognized as valid page placeholders
- BLANK-02: `hasBlankPage: true` set on blank page citations
- BLANK-03: `page` is undefined for blank page citations
- BLANK-04: Confidence is exactly 0.8 for blank page citations
- No regressions in any existing test
</success_criteria>

<output>
After completion, create `.planning/phases/05-type-system-blank-pages/05-02-SUMMARY.md`
</output>
