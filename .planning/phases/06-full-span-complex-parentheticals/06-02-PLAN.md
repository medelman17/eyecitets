---
phase: 06-full-span-complex-parentheticals
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/extract/extractCase.ts
  - src/types/citation.ts
  - tests/extract/extractCase.test.ts
autonomous: true

must_haves:
  truths:
    - "Case citations include caseName field extracted via backward search for 'v.' pattern"
    - "Procedural prefixes (In re, Ex parte, Matter of) extracted as caseName without requiring 'v.'"
    - "fullSpan covers case name through final closing parenthetical including chained parens"
    - "fullSpan includes subsequent history signals (aff'd, rev'd, cert. denied)"
    - "Existing span field unchanged (citation core only) for all citations"
    - "Parentheticals with month/day dates extract court and structured date"
    - "Parentheticals with court only, date only, or both all work correctly"
    - "Year-only parentheticals produce structured date with year-only parsed object"
    - "Chained parentheticals like '(2020) (en banc)' extract both year and disposition"
    - "Disposition field populated for 'en banc' and 'per curiam'"
    - "All existing tests pass unchanged (backward compatibility)"
  artifacts:
    - path: "src/extract/extractCase.ts"
      provides: "Case name extraction, unified parenthetical parser, fullSpan calculation"
      exports: ["extractCase"]
    - path: "src/types/citation.ts"
      provides: "Disposition field on FullCaseCitation"
      contains: "disposition"
    - path: "tests/extract/extractCase.test.ts"
      provides: "Tests for fullSpan, caseName, complex parentheticals, disposition"
      min_lines: 100
  key_links:
    - from: "src/extract/extractCase.ts"
      to: "src/extract/dates.ts"
      via: "import { parseDate } from './dates'"
      pattern: "import.*parseDate.*dates"
    - from: "src/extract/extractCase.ts"
      to: "src/types/citation.ts"
      via: "FullCaseCitation type with fullSpan, caseName, disposition"
      pattern: "disposition"
---

<objective>
Add case name extraction, unified parenthetical parser, and fullSpan calculation to case citation extraction.

Purpose: This plan implements the core Phase 6 features — backward search for case names, forward search for parenthetical boundaries (including chained parens and subsequent history), unified parenthetical parsing (replacing year-only logic), and fullSpan assembly. Together these fulfill all 8 Phase 6 requirements (SPAN-01 through SPAN-04, PAREN-01 through PAREN-04).

Output: Updated extractCase.ts with case name extraction, unified parenthetical parser, fullSpan calculation. Updated citation types with disposition field. Comprehensive tests.
</objective>

<execution_context>
@/Users/medelman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/medelman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-full-span-complex-parentheticals/06-RESEARCH.md
@.planning/phases/06-full-span-complex-parentheticals/06-01-SUMMARY.md

# Source files
@src/extract/extractCase.ts — Current implementation to extend
@src/extract/dates.ts — Date parsing utilities from Plan 06-01
@src/types/citation.ts — Type definitions (fullSpan, caseName already declared; add disposition)
@src/types/span.ts — Span interface
@src/extract/extractCitations.ts — Orchestrator (passes cleanedText to extractCase already)
@tests/extract/extractCase.test.ts — Existing tests that MUST continue passing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement case name extraction, unified parenthetical parser, fullSpan, and disposition</name>
  <files>src/extract/extractCase.ts, src/types/citation.ts</files>
  <action>
    **In src/types/citation.ts:**
    Add `disposition?: string` field to FullCaseCitation interface with JSDoc:
    ```
    /**
     * Disposition or procedural status from parenthetical.
     * Populated by Phase 6 (Complex Parentheticals).
     * @example "en banc", "per curiam"
     */
    disposition?: string
    ```

    **In src/extract/extractCase.ts:**

    1. Add import: `import { parseDate } from './dates'`

    2. Add `extractCaseName` function (backward search):
       - Parameters: cleanedText: string, coreStart: number, maxLookback = 150
       - Returns: { caseName: string; nameStart: number } | undefined
       - Search backward up to maxLookback chars from coreStart
       - Priority 1: Standard "v." format — match pattern ending with comma+optional space before coreStart
         Regex: `/([A-Z][A-Za-z0-9\s.,'&()-]+?)\s+v\.?\s+([A-Za-z0-9\s.,'&()-]+?)\s*,\s*$/` on preceding text
         Allow digits in names for "Doe No. 2" style parties
       - Priority 2: Procedural prefixes — "In re", "Ex parte", "Matter of"
         Regex: `/\b(In re|Ex parte|Matter of)\s+([A-Za-z0-9\s.,'&()-]+?)\s*,\s*$/i`
       - Return caseName (trimmed, comma stripped) and nameStart (absolute position)
       - If no match, return undefined
       - IMPORTANT: Don't match across semicolons (multi-citation separator)

    3. Add `findParentheticalEnd` function (forward search with depth tracking):
       - Parameters: cleanedText: string, searchStart: number, maxLookahead = 200
       - Returns: number (position after final closing paren) or searchStart if no parens
       - Track paren depth (increment on '(', decrement on ')')
       - When depth returns to 0, check if next non-whitespace char is '(' — if so, continue (chained parens)
       - Also check for subsequent history signals AFTER closing paren:
         Pattern: `, aff'd,`, `, rev'd,`, `, cert. denied,`, `, overruled by`, `, vacated by`
         If found, continue scanning for the next parenthetical (subsequent history citations have their own parens)
       - Stop at final closing paren or maxLookahead limit
       - Return position AFTER the last closing paren (exclusive end)

    4. Add `parseParenthetical` function (unified parser):
       - Parameters: content: string (text inside parentheses, without the parens themselves)
       - Returns: { court?: string; year?: number; date?: StructuredDate; disposition?: string }
       - Use parseDate(content) from dates.ts for structured date extraction
       - Use existing stripDateFromCourt(content) for court extraction
       - Check for disposition: /\ben banc\b/i -> "en banc", /\bper curiam\b/i -> "per curiam"
       - Return structured result

    5. Modify the main `extractCase` function:
       - KEEP all existing volume/reporter/page/pincite parsing unchanged
       - REPLACE the existing year/court extraction logic (the inline regex logic and lookahead block) with the unified parseParenthetical:
         a. Find parenthetical content (existing courtRegex or lookahead)
         b. Call parseParenthetical on content
         c. Set year, court, date from result
       - ADD case name extraction: if cleanedText provided, call extractCaseName
       - ADD fullSpan calculation:
         a. Get nameStart from case name result (or use span.cleanStart if no case name)
         b. Call findParentheticalEnd to get span end
         c. Build fullSpan Span object with clean and original positions via transformationMap
         d. If case name not found AND no parenthetical extends beyond core, set fullSpan = undefined
       - ADD disposition: from parseParenthetical result
       - Handle chained parentheticals for disposition:
         After main parenthetical, check for "(en banc)" or "(per curiam)" following
       - ADD date field from parseParenthetical's structured date output
       - For year-only parentheticals (most common case), date.parsed should be { year: NNNN }
       - KEEP existing pincite and court inference logic (scotus from reporter)
       - Return updated citation with fullSpan, caseName, disposition, date fields

    **Critical constraints:**
    - NEVER modify the existing `span` field — it must remain citation core only
    - The `date` field shape must match the existing type: `{ iso: string; parsed?: { year, month?, day? } }`
    - Backward compatibility: citations without case names or parentheticals should work exactly as before
    - The `year` field must still be populated (top-level field, not just in date.parsed)
  </action>
  <verify>
    pnpm typecheck
    pnpm exec vitest run tests/extract/extractCase.test.ts
    (All existing tests must pass — zero regressions)
  </verify>
  <done>
    extractCase returns fullSpan, caseName, disposition, and date fields.
    Existing span field unchanged.
    Existing tests pass.
    Code compiles without type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for Phase 6 features</name>
  <files>tests/extract/extractCase.test.ts</files>
  <action>
    Add new test blocks to tests/extract/extractCase.test.ts:

    **describe('case name extraction (Phase 6)')**
    - "extracts standard case name with v." — "Smith v. Jones, 500 F.2d 123 (2020)" -> caseName: "Smith v. Jones"
    - "extracts case name with multi-word parties" — "United States v. Jones, 500 F.2d 123 (2020)" -> caseName: "United States v. Jones"
    - "extracts procedural prefix: In re" — "In re Smith, 410 U.S. 113 (1973)" -> caseName: "In re Smith"
    - "extracts procedural prefix: Ex parte" — "Ex parte Young, 209 U.S. 123 (1908)" -> caseName: "Ex parte Young"
    - "extracts procedural prefix: Matter of" — "Matter of ABC, 500 F.2d 123 (2020)" -> caseName: "Matter of ABC"
    - "returns undefined caseName when no case name present" — "500 F.2d 123 (2020)" -> caseName: undefined
    - "handles case name with 'Inc.' and abbreviations" — "Acme Corp., Inc. v. Doe, 500 F.2d 123 (2020)" -> caseName includes "Inc."

    **describe('fullSpan calculation (Phase 6)')**
    - "fullSpan covers case name through parenthetical" — "Smith v. Jones, 500 F.2d 123 (2020)" -> fullSpan.originalStart: 0, fullSpan.originalEnd: end of ")"
    - "fullSpan includes chained parentheticals" — "Smith v. Jones, 500 F.2d 123 (9th Cir. 2020) (en banc)" -> fullSpan covers all
    - "fullSpan undefined when no case name" — "500 F.2d 123 (2020)" -> fullSpan: undefined
    - "existing span unchanged (core only)" — verify span.originalStart/End point only to "500 F.2d 123" portion
    - "fullSpan includes subsequent history" — "Smith v. Jones, 500 F.2d 123 (2d Cir. 1990), aff'd, 501 U.S. 1 (1991)" -> fullSpan covers entire string

    **describe('unified parenthetical parser (Phase 6)')**
    - "extracts court and year from standard parenthetical" — "(9th Cir. 2020)" -> court: "9th Cir.", year: 2020
    - "extracts court and full date: abbreviated month" — "(2d Cir. Jan. 15, 2020)" -> court: "2d Cir.", year: 2020, date.iso: "2020-01-15"
    - "extracts court and full date: full month name" — "(D. Mass. January 15, 2020)" -> court: "D. Mass.", date.iso: "2020-01-15"
    - "extracts court and full date: numeric format" — "(D. Mass. 1/15/2020)" -> court: "D. Mass.", date.iso: "2020-01-15"
    - "handles year-only parenthetical" — "(2020)" -> year: 2020, date: { iso: "2020", parsed: { year: 2020 } }
    - "handles court-only with year" — "(9th Cir. 2020)" -> court: "9th Cir.", year: 2020
    - "structured date for year-only" — "(1973)" -> date.parsed: { year: 1973 }
    - "structured date for full date" — date.parsed: { year: 2020, month: 1, day: 15 }

    **describe('disposition extraction (Phase 6)')**
    - "extracts en banc from chained paren" — "500 F.2d 123 (9th Cir. 2020) (en banc)" -> disposition: "en banc"
    - "extracts per curiam" — "500 F.2d 123 (per curiam)" -> disposition: "per curiam"
    - "no disposition when not present" — "500 F.2d 123 (2020)" -> disposition: undefined

    **describe('backward compatibility (Phase 6)')**
    - "year-only extraction still works" — "(1973)" -> year: 1973
    - "court extraction still works" — "(9th Cir. 2020)" -> court: "9th Cir."
    - "pincite extraction unchanged" — "500 F.2d 123, 125 (2020)" -> pincite: 125
    - "scotus inference from reporter unchanged" — "410 U.S. 113 (1973)" -> court: "scotus"
    - "blank page citations still work" — "500 F.2d ___ (2020)" -> hasBlankPage: true, page: undefined

    Use extractCitations(text) from the public API (not extractCase directly) so tests validate the full pipeline including cleanedText passing.
  </action>
  <verify>
    pnpm exec vitest run tests/extract/extractCase.test.ts
    pnpm exec vitest run  # All tests pass (full suite)
    pnpm typecheck
  </verify>
  <done>
    All new Phase 6 tests pass.
    All existing tests pass (zero regressions).
    Full test suite green.
    Type checking passes.
  </done>
</task>

</tasks>

<verification>
pnpm exec vitest run                    # All tests pass
pnpm typecheck                          # No type errors
pnpm lint                               # No lint errors
pnpm build                              # Build succeeds
</verification>

<success_criteria>
- SPAN-01: caseName extracted via backward search for "v." and procedural prefixes
- SPAN-02: fullSpan covers case name through closing parenthetical (including chained)
- SPAN-03: caseName field populated on FullCaseCitation
- SPAN-04: Existing span field unchanged (citation core only)
- PAREN-01: Court extracted from parentheticals with month/day dates
- PAREN-02: Structured date with year, month, day fields
- PAREN-03: Court only, date only, or both all work
- PAREN-04: Three date formats handled (abbreviated, full month, numeric)
- Disposition field populated for en banc, per curiam
- Chained parentheticals tracked in fullSpan
- All existing tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-full-span-complex-parentheticals/06-02-SUMMARY.md`
</output>
